# ç”¨æˆ·åˆ†ææ’ä»¶"æœªå¯ç”¨"é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ” é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šç”¨æˆ·åˆ†ææ’ä»¶æ˜æ˜å·²å¯ç”¨ï¼Œä½†å‰ç«¯ä»æç¤º"ç”¨æˆ·åˆ†ææ’ä»¶æœªå¯ç”¨"ã€‚

## ğŸ› é—®é¢˜æ ¹å› 

### æ ¸å¿ƒé—®é¢˜ï¼šPluginManagerå®ä¾‹ä¸ä¸€è‡´

**server.pyä¸­çš„é—®é¢˜ä»£ç **ï¼š
```python
# å…¨å±€å®šä¹‰ï¼ˆç¬¬44è¡Œï¼‰
plugin_manager = PluginManager(plugin_dir="./plugins")

# ä½†åœ¨APIå‡½æ•°ä¸­åˆåˆ›å»ºäº†æ–°å®ä¾‹ï¼
@app.get("/api/analytics/global")
async def get_global_analytics():
    from core.plugin_system import PluginManager
    
    plugin_manager = PluginManager()  # âŒ åˆ›å»ºäº†æ–°å®ä¾‹ï¼
    user_analytics_plugin = plugin_manager.get_plugin("ç”¨æˆ·åˆ†æ")
    ...
```

### ä¸ºä»€ä¹ˆä¼šå¯¼è‡´"æœªå¯ç”¨"ï¼Ÿ

1. **å…¨å±€`plugin_manager`**: åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶åŠ è½½äº†æ‰€æœ‰æ’ä»¶
2. **APIä¸­çš„æ–°å®ä¾‹**: æ¯æ¬¡è°ƒç”¨APIéƒ½åˆ›å»ºæ–°çš„`PluginManager`ï¼Œæ²¡æœ‰åŠ è½½ä»»ä½•æ’ä»¶
3. **ç»“æœ**: æ–°å®ä¾‹çš„`plugins`å­—å…¸æ˜¯ç©ºçš„ï¼Œ`get_plugin()`è¿”å›`None`

### å½±å“èŒƒå›´

æ‰€æœ‰ç”¨æˆ·åˆ†æå’Œç­¾åˆ°æŠ½ç­¾ç›¸å…³çš„APIéƒ½æœ‰è¿™ä¸ªé—®é¢˜ï¼š
- `/api/analytics/global` - è·å–å…¨å±€åˆ†æ
- `/api/analytics/user/{user_name}` - è·å–ç”¨æˆ·ç”»åƒ
- `/api/analytics/memory/{user_name}` - è·å–ç”¨æˆ·è®°å¿†
- `/api/analytics/search` - æœç´¢ç”¨æˆ·
- `/api/analytics/clear-old-data` - æ¸…ç†æ—§æ•°æ®
- `/api/checkin/stats` - è·å–ç­¾åˆ°ç»Ÿè®¡
- `/api/lottery/stats` - è·å–æŠ½ç­¾ç»Ÿè®¡

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹å†…å®¹

å°†æ‰€æœ‰APIå‡½æ•°ä¸­çš„å±€éƒ¨`plugin_manager`æ”¹ä¸ºä½¿ç”¨å…¨å±€å®ä¾‹ã€‚

**ä¿®æ”¹å‰**ï¼š
```python
@app.get("/api/analytics/global")
async def get_global_analytics():
    from core.plugin_system import PluginManager
    
    plugin_manager = PluginManager()  # âŒ å±€éƒ¨å˜é‡ï¼Œè¦†ç›–å…¨å±€
    user_analytics_plugin = plugin_manager.get_plugin("ç”¨æˆ·åˆ†æ")
    
    if user_analytics_plugin:
        ...
```

**ä¿®æ”¹å**ï¼š
```python
@app.get("/api/analytics/global")
async def get_global_analytics():
    # âœ… ç›´æ¥ä½¿ç”¨å…¨å±€ plugin_manager
    user_analytics_plugin = plugin_manager.get_plugin("ç”¨æˆ·åˆ†æ")
    
    if user_analytics_plugin and user_analytics_plugin.enabled:
        ...
```

### æ”¹è¿›ç‚¹

1. **ç§»é™¤å±€éƒ¨å˜é‡**: åˆ é™¤äº†`plugin_manager = PluginManager()`
2. **ä½¿ç”¨å…¨å±€å®ä¾‹**: ç›´æ¥å¼•ç”¨å…¨å±€çš„`plugin_manager`
3. **å¢åŠ enabledæ£€æŸ¥**: æ·»åŠ `plugin_manager.enabled`æ£€æŸ¥ï¼Œç¡®ä¿æ’ä»¶çœŸæ­£å¯ç”¨

## ğŸ“ ä¿®æ”¹çš„APIåˆ—è¡¨

### ç”¨æˆ·åˆ†æç›¸å…³ (5ä¸ªAPI)
1. âœ… `GET /api/analytics/global` - è·å–å…¨å±€åˆ†ææ•°æ®
2. âœ… `GET /api/analytics/user/{user_name}` - è·å–ç”¨æˆ·ç”»åƒ
3. âœ… `GET /api/analytics/memory/{user_name}` - è·å–ç”¨æˆ·è®°å¿†
4. âœ… `GET /api/analytics/search` - æ ¹æ®å…´è¶£æœç´¢ç”¨æˆ·
5. âœ… `POST /api/analytics/clear-old-data` - æ¸…ç†æ—§æ•°æ®

### ç­¾åˆ°æŠ½ç­¾ç›¸å…³ (2ä¸ªAPI)
6. âœ… `GET /api/checkin/stats` - è·å–ç­¾åˆ°ç»Ÿè®¡
7. âœ… `GET /api/lottery/stats` - è·å–æŠ½ç­¾ç»Ÿè®¡

## ğŸ”§ æŠ€æœ¯è¯´æ˜

### Pythonå˜é‡ä½œç”¨åŸŸé—®é¢˜

```python
# å…¨å±€å˜é‡
plugin_manager = PluginManager()

def some_function():
    # è¿™é‡Œåˆ›å»ºäº†åŒåçš„å±€éƒ¨å˜é‡ï¼Œä¼šè¦†ç›–å…¨å±€å˜é‡
    plugin_manager = PluginManager()  # âŒ å±€éƒ¨å˜é‡
    
def another_function():
    # è¿™é‡Œç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡
    plugin = plugin_manager.get_plugin("xxx")  # âœ… å…¨å±€å˜é‡
```

### ä¸ºä»€ä¹ˆä¹‹å‰æ²¡å‘ç°ï¼Ÿ

1. **æ’ä»¶ç³»ç»Ÿæ­£å¸¸å·¥ä½œ**: å¼¹å¹•å¤„ç†ç­‰åŠŸèƒ½ä½¿ç”¨çš„æ˜¯å…¨å±€`plugin_manager`
2. **åªæœ‰ç‰¹å®šAPIæœ‰é—®é¢˜**: åªæœ‰è¿™äº›ç»Ÿè®¡APIåˆ›å»ºäº†æ–°å®ä¾‹
3. **å®¹æ˜“è¢«å¿½ç•¥**: ä»£ç çœ‹èµ·æ¥"æ­£å¸¸"ï¼Œåªæ˜¯å®ä¾‹ä¸å¯¹

## ğŸ§ª éªŒè¯æ–¹æ³•

### 1. æµ‹è¯•APIå“åº”
```bash
# å¯åŠ¨æœåŠ¡å™¨åï¼Œè®¿é—®API
curl http://localhost:8000/api/analytics/global
```

**ä¿®å¤å‰**ï¼š
```json
{
  "success": false,
  "message": "ç”¨æˆ·åˆ†ææ’ä»¶æœªå¯ç”¨"
}
```

**ä¿®å¤å**ï¼š
```json
{
  "success": true,
  "data": {
    "total_messages": 0,
    "total_users": 0,
    ...
  }
}
```

### 2. å‰ç«¯æµ‹è¯•
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
2. åˆ‡æ¢åˆ°"ç”¨æˆ·åˆ†æ"æ ‡ç­¾é¡µ
3. è§‚å¯Ÿæ˜¯å¦æ˜¾ç¤ºç»Ÿè®¡æ•°æ®ï¼ˆè€Œä¸æ˜¯"æœªå¯ç”¨"æç¤ºï¼‰

### 3. æ—¥å¿—æ£€æŸ¥
æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼Œä¸åº”è¯¥å‡ºç°"ç”¨æˆ·åˆ†ææ’ä»¶æœªå¯ç”¨"çš„é”™è¯¯ã€‚

## ğŸ“Š é¢„æœŸç»“æœ

âœ… æ‰€æœ‰ç”¨æˆ·åˆ†æAPIè¿”å›æ­£ç¡®æ•°æ®
âœ… å‰ç«¯"ç”¨æˆ·åˆ†æ"é¡µé¢æ­£å¸¸æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
âœ… ç­¾åˆ°æŠ½ç­¾APIä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
âœ… ä¸å†å‡ºç°"æ’ä»¶æœªå¯ç”¨"çš„é”™è¯¯æç¤º

## ğŸ¯ æœ€ä½³å®è·µå»ºè®®

### 1. é¿å…é‡å¤åˆ›å»ºå•ä¾‹å¯¹è±¡
```python
# âŒ ä¸å¥½çš„åšæ³•
def api_function():
    manager = PluginManager()  # æ¯æ¬¡éƒ½åˆ›å»ºæ–°å®ä¾‹
    
# âœ… å¥½çš„åšæ³•
# å…¨å±€åˆ›å»ºä¸€æ¬¡
plugin_manager = PluginManager()

def api_function():
    # ç›´æ¥ä½¿ç”¨å…¨å±€å®ä¾‹
    plugin = plugin_manager.get_plugin("xxx")
```

### 2. ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼ˆFastAPIæ¨èï¼‰
```python
from fastapi import Depends

def get_plugin_manager():
    return plugin_manager

@app.get("/api/analytics/global")
async def get_global_analytics(
    pm: PluginManager = Depends(get_plugin_manager)
):
    plugin = pm.get_plugin("ç”¨æˆ·åˆ†æ")
    ...
```

### 3. æ·»åŠ å•å…ƒæµ‹è¯•
```python
def test_analytics_api():
    response = client.get("/api/analytics/global")
    assert response.status_code == 200
    assert response.json()["success"] == True
```

## ğŸ“Œ æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**å˜é‡ä½œç”¨åŸŸ**é—®é¢˜ï¼š
- **è¡¨é¢ç°è±¡**: æ’ä»¶æœªå¯ç”¨
- **å®é™…åŸå› **: ä½¿ç”¨äº†é”™è¯¯çš„PluginManagerå®ä¾‹
- **ä¿®å¤æ–¹æ³•**: ç»Ÿä¸€ä½¿ç”¨å…¨å±€å®ä¾‹
- **é¢„é˜²æªæ–½**: ä»£ç å®¡æŸ¥ã€å•å…ƒæµ‹è¯•

ä¿®å¤åï¼Œç”¨æˆ·åˆ†æå’Œç­¾åˆ°æŠ½ç­¾çš„æ‰€æœ‰åŠŸèƒ½éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼
