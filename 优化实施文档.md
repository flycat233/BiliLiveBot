# BililiveRobot 优化实施文档

## 优化概览

本次优化全面提升了系统的稳定性、性能和可维护性，实现了所有建议的优化功能。

## 新增模块

### 1. 日志系统 (`core/logger.py`)

**功能：**
- 统一的日志管理
- 文件日志轮转（最大10MB，保留5个备份）
- 控制台和文件双输出
- 支持不同日志级别

**使用方法：**
```python
from core.logger import get_logger

logger = get_logger("my_module")
logger.info("信息日志")
logger.warning("警告日志")
logger.error("错误日志", exc_info=True)
```

### 2. 配置管理 (`core/config.py`)

**功能：**
- 统一配置管理
- 支持嵌套配置（点号分隔）
- 敏感信息加密存储
- 自动生成和管理加密密钥

**使用方法：**
```python
from core.config import get_config, set_config, config_manager

# 获取配置
host = get_config('server.host', '127.0.0.1')

# 设置配置
set_config('server.port', 8000)

# 加密敏感信息
encrypted = config_manager.encrypt("sensitive_data")
decrypted = config_manager.decrypt(encrypted)
```

**默认配置：**
```json
{
  "server": {
    "host": "127.0.0.1",
    "port": 8000,
    "reload": true,
    "log_level": "info"
  },
  "security": {
    "enable_auth": false,
    "jwt_expire_hours": 24
  },
  "reconnect": {
    "enable_auto_reconnect": true,
    "max_retries": 5,
    "retry_delay_seconds": 5,
    "exponential_backoff": true
  },
  "monitoring": {
    "enable_performance_monitor": true,
    "metrics_interval_seconds": 60
  },
  "database": {
    "backup_enabled": true,
    "backup_interval_hours": 24
  }
}
```

### 3. 数据库模块 (`core/database.py`)

**功能：**
- SQLite数据持久化
- 自动创建表结构和索引
- 上下文管理器自动处理事务
- 数据备份和清理

**数据表：**
- `user_analytics` - 用户分析数据
- `danmaku_records` - 弹幕记录
- `gift_records` - 礼物记录
- `checkin_records` - 签到记录
- `lottery_records` - 抽签记录
- `performance_metrics` - 性能指标
- `error_logs` - 错误日志

**使用方法：**
```python
from core.database import db

# 保存用户分析数据
db.save_user_analytics({
    'user_name': '用户名',
    'danmaku_count': 10,
    'gift_value': 100.0
})

# 获取用户数据
user = db.get_user_analytics('用户名')

# 保存弹幕
db.save_danmaku(danmaku_data)

# 备份数据库
db.backup()

# 清理旧数据
db.clean_old_data(days=30)
```

### 4. 性能监控 (`core/performance.py`)

**功能：**
- CPU和内存使用率监控
- 弹幕处理时间统计
- 插件执行时间追踪
- 健康状态检查

**使用方法：**
```python
from core.performance import performance_monitor

# 启动监控
await performance_monitor.start_monitoring(interval=60)

# 记录处理时间
performance_monitor.record_danmaku_processing(0.05)

# 记录插件执行时间
performance_monitor.record_plugin_execution('插件名', 0.02)

# 获取当前指标
metrics = performance_monitor.get_current_metrics()

# 获取健康状态
health = performance_monitor.get_health_status()

# 停止监控
await performance_monitor.stop_monitoring()
```

### 5. API认证 (`core/auth_api.py`)

**功能：**
- JWT令牌认证
- API密钥管理
- FastAPI依赖注入集成

**使用方法：**
```python
from core.auth_api import api_auth, get_current_user
from fastapi import Depends

# 生成令牌
token = api_auth.generate_token('user_id')

# 验证令牌
payload = api_auth.verify_token(token)

# 在API中使用（需要认证）
@app.get("/protected")
async def protected_route(user = Depends(get_current_user)):
    return {"user": user}
```

### 6. 增强弹幕客户端 (`core/danmaku_enhanced.py`)

**功能：**
- 自动断线重连
- 指数退避重试策略
- 详细的错误日志
- 性能监控集成

**使用方法：**
```python
from core.danmaku_enhanced import EnhancedDanmakuClient

client = EnhancedDanmakuClient(room_id, cookies)

# 设置重连回调
client.on_reconnect_start = lambda: print("开始重连")
client.on_reconnect_success = lambda: print("重连成功")
client.on_reconnect_failed = lambda: print("重连失败")

# 连接
await client.connect()

# 自动重连会在连接断开时自动触发
```

### 7. 缓存模块 (`core/cache.py`)

**功能：**
- LRU缓存策略
- TTL过期时间
- 缓存统计
- 装饰器支持

**使用方法：**
```python
from core.cache import cache, cached

# 直接使用
cache.set('key', 'value', ttl=60)
value = cache.get('key')

# 使用装饰器
@cached(ttl=60, key_prefix="api:")
async def expensive_function(param):
    # 耗时操作
    return result

# 获取统计信息
stats = cache.get_stats()

# 清理过期项
cache.cleanup_expired()
```

### 8. 增强插件基类 (`core/plugin_base.py`)

**功能：**
- 生命周期钩子（init, destroy, enable, disable）
- 插件依赖管理
- 插件优先级
- 性能监控集成

**使用方法：**
```python
from core.plugin_base import PluginBaseEnhanced

class MyPlugin(PluginBaseEnhanced):
    name = "我的插件"
    dependencies = ["其他插件"]
    priority = 50
    
    async def on_init(self):
        # 初始化资源
        pass
    
    async def on_destroy(self):
        # 清理资源
        pass
    
    async def _on_danmaku_impl(self, data):
        # 处理弹幕
        return data
```

### 9. 数据导出 (`core/exporter.py`)

**功能：**
- JSON和CSV格式导出
- 用户分析数据导出
- 弹幕记录导出
- 性能指标导出
- 错误日志导出

**使用方法：**
```python
from core.exporter import exporter

# 导出用户分析数据
filepath = exporter.export_user_analytics(format='json')

# 导出弹幕记录
filepath = exporter.export_danmaku_records(room_id=123456, format='csv')

# 获取导出文件列表
files = exporter.get_export_list()

# 删除导出文件
exporter.delete_export('filename.json')
```

### 10. API扩展 (`api_extended.py`)

**新增API端点：**

#### 性能监控
- `GET /api/v2/performance/metrics` - 获取性能指标
- `GET /api/v2/performance/health` - 获取健康状态

#### 缓存管理
- `GET /api/v2/cache/stats` - 获取缓存统计
- `POST /api/v2/cache/clear` - 清空缓存
- `POST /api/v2/cache/cleanup` - 清理过期缓存

#### 数据库管理
- `POST /api/v2/database/backup` - 备份数据库
- `POST /api/v2/database/cleanup?days=30` - 清理旧数据

#### 数据导出
- `POST /api/v2/export` - 导出数据
- `GET /api/v2/export/list` - 获取导出列表
- `GET /api/v2/export/download/{filename}` - 下载导出文件
- `DELETE /api/v2/export/{filename}` - 删除导出文件

#### 用户分析
- `GET /api/v2/analytics/users?limit=100` - 获取所有用户
- `GET /api/v2/analytics/user/{user_name}` - 获取用户详情

#### 配置管理
- `GET /api/v2/config` - 获取配置

#### 系统信息
- `GET /api/v2/system/info` - 获取系统信息

## 使用指南

### 1. 安装依赖

```bash
cd backend
pip install -r requirements.txt
```

新增依赖：
- `pyjwt>=2.8.0` - JWT认证
- `psutil>=5.9.0` - 系统监控

### 2. 启动增强版服务器

```bash
# 使用增强版启动脚本
python server_enhanced.py
```

或者在原server.py中集成：

```python
# 在server.py开头添加
from core.logger import get_logger
from core.config import get_config
from core.database import db
from core.performance import performance_monitor
import api_extended

logger = get_logger("server")

# 注册扩展API
app.include_router(api_extended.router)

# 在startup事件中添加
@app.on_event("startup")
async def startup_event():
    # 原有代码...
    
    # 启动性能监控
    if get_config('monitoring.enable_performance_monitor'):
        await performance_monitor.start_monitoring(60)
    
    logger.info("增强功能已启用")

# 在shutdown事件中添加
@app.on_event("shutdown")
async def shutdown_event():
    # 原有代码...
    
    # 停止性能监控
    await performance_monitor.stop_monitoring()
    
    # 备份数据库
    db.backup()
    
    logger.info("增强功能已关闭")
```

### 3. 使用增强弹幕客户端

在`server.py`中替换原有的DanmakuClient：

```python
# 修改导入
from core.danmaku_enhanced import EnhancedDanmakuClient

# 在connect_room函数中
danmaku_client = EnhancedDanmakuClient(room_id, cookies)

# 设置重连回调
danmaku_client.on_reconnect_start = lambda: asyncio.create_task(
    manager.broadcast({"type": "reconnecting", "message": "正在重连..."})
)

danmaku_client.on_reconnect_success = lambda: asyncio.create_task(
    manager.broadcast({"type": "reconnected", "message": "重连成功"})
)

danmaku_client.on_reconnect_failed = lambda: asyncio.create_task(
    manager.broadcast({"type": "reconnect_failed", "message": "重连失败"})
)
```

### 4. 配置文件

首次运行会在`./data/config.json`生成默认配置，可以根据需要修改：

```json
{
  "server": {
    "host": "0.0.0.0",
    "port": 8000
  },
  "security": {
    "enable_auth": true,
    "api_keys": ["your-api-key-here"]
  },
  "reconnect": {
    "max_retries": 10,
    "retry_delay_seconds": 3
  }
}
```

### 5. 数据库管理

数据库文件位于`./data/database.db`

备份文件位于`./data/backups/`

可以使用SQLite工具查看：
```bash
sqlite3 ./data/database.db
```

### 6. 日志查看

日志文件位于`./logs/`目录：
- `server.log` - 服务器日志
- `database.log` - 数据库日志
- `performance.log` - 性能监控日志
- `danmaku_enhanced.log` - 弹幕客户端日志
- `plugin.{name}.log` - 各插件日志

## 性能优化效果

### 1. 断线重连
- ✅ 自动检测连接断开
- ✅ 指数退避重试策略
- ✅ 最多重试5次（可配置）
- ✅ 重连状态实时通知

### 2. 错误处理
- ✅ 详细的错误日志
- ✅ 错误类型分类
- ✅ 堆栈跟踪记录
- ✅ 错误统计和监控

### 3. 性能监控
- ✅ CPU使用率监控
- ✅ 内存使用率监控
- ✅ 弹幕处理延迟监控
- ✅ 插件执行时间监控
- ✅ 健康状态检查

### 4. 数据持久化
- ✅ SQLite数据库存储
- ✅ 自动备份机制
- ✅ 数据清理功能
- ✅ 数据导出功能

### 5. 缓存机制
- ✅ LRU缓存策略
- ✅ TTL过期控制
- ✅ 缓存命中率统计
- ✅ 装饰器简化使用

### 6. 安全性
- ✅ JWT令牌认证
- ✅ API密钥验证
- ✅ 敏感信息加密
- ✅ 配置文件权限控制

## 测试建议

### 1. 功能测试

```bash
# 测试性能监控
curl http://localhost:8000/api/v2/performance/metrics

# 测试健康检查
curl http://localhost:8000/api/v2/performance/health

# 测试缓存统计
curl http://localhost:8000/api/v2/cache/stats

# 测试数据导出
curl -X POST http://localhost:8000/api/v2/export \
  -H "Content-Type: application/json" \
  -d '{"data_type":"user_analytics","format":"json"}'
```

### 2. 压力测试

```python
# test_stress.py
import asyncio
import aiohttp

async def test_concurrent_connections():
    """测试并发连接"""
    async with aiohttp.ClientSession() as session:
        tasks = []
        for i in range(100):
            task = session.get('http://localhost:8000/api/v2/performance/metrics')
            tasks.append(task)
        
        responses = await asyncio.gather(*tasks)
        print(f"完成{len(responses)}个并发请求")

asyncio.run(test_concurrent_connections())
```

### 3. 断线重连测试

1. 启动服务器并连接直播间
2. 断开网络连接
3. 观察日志中的重连尝试
4. 恢复网络连接
5. 验证是否自动重连成功

## 监控和维护

### 1. 日常监控

- 查看健康状态：`GET /api/v2/performance/health`
- 检查性能指标：`GET /api/v2/performance/metrics`
- 查看缓存效率：`GET /api/v2/cache/stats`

### 2. 定期维护

- 每周备份数据库：`POST /api/v2/database/backup`
- 每月清理旧数据：`POST /api/v2/database/cleanup?days=30`
- 定期导出重要数据

### 3. 故障排查

1. 查看日志文件
2. 检查健康状态
3. 查看错误日志表
4. 分析性能指标

## 升级路径

### 从旧版本升级

1. 备份现有数据
```bash
cp -r data data_backup
```

2. 安装新依赖
```bash
pip install -r requirements.txt
```

3. 运行数据库迁移（如果需要）
```python
from core.database import db
# 数据库会自动创建新表
```

4. 更新配置文件
```python
from core.config import config_manager
# 配置会自动生成默认值
```

5. 测试新功能

## 常见问题

### Q: 如何禁用某些功能？

A: 修改配置文件：
```json
{
  "monitoring": {
    "enable_performance_monitor": false
  },
  "reconnect": {
    "enable_auto_reconnect": false
  }
}
```

### Q: 数据库文件太大怎么办？

A: 定期清理旧数据：
```bash
curl -X POST "http://localhost:8000/api/v2/database/cleanup?days=7"
```

### Q: 如何查看详细日志？

A: 设置日志级别为DEBUG：
```python
from core.logger import logger_manager
logger_manager.set_level("server", logging.DEBUG)
```

### Q: 如何启用API认证？

A: 修改配置并生成API密钥：
```python
from core.auth_api import api_auth
from core.config import set_config

# 生成API密钥
api_key = api_auth.generate_api_key()
print(f"API密钥: {api_key}")

# 启用认证
set_config('security.enable_auth', True)
set_config('security.api_keys', [api_key])
```

## 总结

本次优化实现了：
- ✅ 完善的日志系统
- ✅ 统一的配置管理
- ✅ 数据持久化和备份
- ✅ 性能监控和健康检查
- ✅ 自动断线重连
- ✅ 缓存机制
- ✅ API认证
- ✅ 数据导出
- ✅ 增强的插件系统
- ✅ 扩展的API接口

系统的稳定性、性能和可维护性得到全面提升！
