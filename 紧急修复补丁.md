# 紧急修复补丁 - 插件错误和在线人数显示

## 问题描述

1. **插件错误**: 所有插件报错 `'Plugin' object has no attribute 'is_bot_message'`
2. **在线人数不显示**: 直播间在线人数等信息未正确显示

## 问题原因

### 问题1：插件缺少方法
原有的`PluginBase`类缺少`is_bot_message`方法，导致插件在处理弹幕时报错。

### 问题2：在线人数数据结构不匹配
- 后端发送的数据结构：`{"type": "online", "data": {"online": 123}}`
- 前端期望的数据结构：`data.data.online`
- 但在线人数事件被插件系统处理，导致数据结构改变

## 修复内容

### 修复1：添加`is_bot_message`方法到PluginBase

**文件**: `core/plugin_system.py`

**修改位置1** - 在`__init__`方法中添加：
```python
def __init__(self):
    """初始化插件"""
    self.enabled = True
    self.config = {}
    self.bot_messages = set()  # 存储机器人发送的消息ID
    self.load_config()
```

**修改位置2** - 在`update_config`方法后添加：
```python
def is_bot_message(self, data: dict) -> bool:
    """
    检查是否是机器人自己发送的消息
    
    Args:
        data: 弹幕数据
        
    Returns:
        bool: 是否是机器人消息
    """
    # 检查消息ID是否在机器人消息集合中
    msg_id = data.get('msg_id') or data.get('id')
    if msg_id and msg_id in self.bot_messages:
        return True
    
    # 检查用户名是否是机器人自己
    # 这里可以根据实际情况添加更多判断逻辑
    return False

def mark_as_bot_message(self, msg_id: str):
    """
    标记消息为机器人消息
    
    Args:
        msg_id: 消息ID
    """
    self.bot_messages.add(msg_id)
    
    # 限制集合大小，避免内存泄漏
    if len(self.bot_messages) > 1000:
        # 移除最旧的500个
        self.bot_messages = set(list(self.bot_messages)[500:])
```

### 修复2：在线人数事件不经过插件系统

**文件**: `server.py`

**修改位置** - 修改`handle_danmaku`函数：
```python
async def handle_danmaku(event_type: str, data: dict):
    """处理弹幕数据（通过插件系统）"""
    try:
        # 对于online事件，直接广播，不通过插件系统
        if event_type == "online":
            await manager.broadcast({
                "type": event_type,
                "data": data  # data已经是 {"online": xxx} 格式
            })
            return
        
        # 通过插件系统处理其他事件
        processed_data = await plugin_manager.process_event(event_type, data)
        
        # 如果插件返回 None，表示过滤掉该消息
        if processed_data is None:
            return
        
        # 广播到所有客户端
        await manager.broadcast({
            "type": event_type,
            "data": processed_data
        })
    
    except Exception as e:
        print(f"处理弹幕错误: {e}")
```

## 应用修复

### 方式1：手动应用（推荐）

1. 打开 `core/plugin_system.py`
2. 找到 `PluginBase` 类的 `__init__` 方法
3. 添加 `self.bot_messages = set()`
4. 在 `update_config` 方法后添加 `is_bot_message` 和 `mark_as_bot_message` 方法

5. 打开 `server.py`
6. 找到 `handle_danmaku` 函数
7. 在函数开头添加对 `online` 事件的特殊处理

### 方式2：使用Git（如果有版本控制）

```bash
# 应用补丁
git apply fix_plugin_errors.patch
```

## 测试修复

1. 重启服务器：
```bash
python server.py
```

2. 连接到直播间

3. 验证以下内容：
   - ✅ 插件不再报错
   - ✅ 在线人数正确显示
   - ✅ 弹幕正常接收
   - ✅ 其他统计数据正常

## 预期结果

### 修复前
```
插件 自动欢迎语 处理事件 danmaku 失败: 'AutoWelcomePlugin' object has no attribute 'is_bot_message'
插件 签到抽签 处理事件 danmaku 失败: 'CheckinLotteryPlugin' object has no attribute 'is_bot_message'
插件 用户分析 处理事件 danmaku 失败: 'UserAnalyticsPlugin' object has no attribute 'is_bot_message'
在线人数: 0（不更新）
```

### 修复后
```
已向客户端发送连接成功消息，房间号: 10055155
在线人数: 12345（实时更新）
弹幕正常接收和处理
插件正常工作
```

## 其他注意事项

### 1. 如果使用了增强版插件基类

如果你的插件继承自 `PluginBaseEnhanced`（在 `core/plugin_base.py` 中），也需要确保该类包含这些方法。

**检查文件**: `core/plugin_base.py`

如果该文件存在，确保 `PluginBaseEnhanced` 继承自更新后的 `PluginBase`：

```python
from core.plugin_system import PluginBase

class PluginBaseEnhanced(PluginBase):
    # ... 其他代码
```

这样 `PluginBaseEnhanced` 会自动继承 `is_bot_message` 方法。

### 2. 清理缓存

如果修复后仍有问题，尝试清理Python缓存：

```bash
# Windows
Remove-Item -Recurse -Force __pycache__
Remove-Item -Recurse -Force core\__pycache__
Remove-Item -Recurse -Force plugins\__pycache__

# Linux/Mac
find . -type d -name __pycache__ -exec rm -rf {} +
```

### 3. 重新加载插件

如果服务器已经在运行，需要重启才能加载修复后的代码：

```bash
# 停止服务器 (Ctrl+C)
# 重新启动
python server.py
```

## 验证清单

- [ ] `core/plugin_system.py` 已修改
- [ ] `server.py` 已修改
- [ ] Python缓存已清理
- [ ] 服务器已重启
- [ ] 连接到直播间成功
- [ ] 插件不再报错
- [ ] 在线人数正常显示
- [ ] 弹幕正常接收
- [ ] 其他功能正常

## 完成！

修复完成后，所有功能应该恢复正常。如果还有问题，请检查：

1. 日志文件：`./logs/server.log`
2. 控制台输出
3. 浏览器控制台（F12）

如有其他问题，请参考完整的优化文档。
