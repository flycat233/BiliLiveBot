# ğŸ¯ BililiveRobot å®Œæ•´ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¸…å•

æ‚¨æŠ¥å‘Šçš„é—®é¢˜ï¼š
1. âŒ ç”¨æˆ·åˆ†ææ’ä»¶ä¸èµ·ä½œç”¨
2. âŒ æ’ä»¶æ˜æ˜å¯åŠ¨äº†ä»æ˜¾ç¤ºæœªå¯åŠ¨
3. âŒ çˆ†ç‚¹ç›‘æµ‹ä¸èµ·ä½œç”¨

æ’æŸ¥è¿‡ç¨‹ä¸­å‘ç°çš„é—®é¢˜ï¼š
4. âŒ WebSocketè¿æ¥å¤±è´¥ (AttributeError: 'ClientConnection' object has no attribute 'closed')
5. âŒ ç”¨æˆ·åˆ†æAPIæç¤º"æœªå¯ç”¨" (PluginManagerå®ä¾‹ä¸ä¸€è‡´)

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ç”¨æˆ·åˆ†ææ’ä»¶ä¿®å¤

**æ–‡ä»¶**: `plugins/user_analytics.py`

**é—®é¢˜**: æ’ä»¶ç»§æ‰¿äº†`PluginBaseEnhanced`ï¼Œä½†ç›´æ¥é‡å†™äº†`on_danmaku`æ–¹æ³•ï¼Œç»•è¿‡äº†æ€§èƒ½ç›‘æ§å±‚

**ä¿®å¤**: 
```python
# ä¿®æ”¹å‰
async def on_danmaku(self, data: dict) -> Optional[dict]:
    """å¤„ç†å¼¹å¹•äº‹ä»¶"""
    ...

# ä¿®æ”¹å  
async def _on_danmaku_impl(self, data: dict) -> Optional[dict]:
    """å¤„ç†å¼¹å¹•äº‹ä»¶"""
    ...
```

**åŸç†**: `PluginBaseEnhanced`ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œå­ç±»åº”é‡å†™`_on_danmaku_impl`è€Œä¸æ˜¯`on_danmaku`

---

### 2. æ’ä»¶çŠ¶æ€æ˜¾ç¤ºä¿®å¤

**æ–‡ä»¶**: `templates/index.html` (ç¬¬2233è¡Œ)

**é—®é¢˜**: åˆ‡æ¢æ’ä»¶çŠ¶æ€åï¼Œå‰ç«¯æ²¡æœ‰é‡æ–°åŠ è½½æ’ä»¶åˆ—è¡¨ï¼Œå¯¼è‡´UIä¸æœåŠ¡å™¨çŠ¶æ€ä¸åŒæ­¥

**ä¿®å¤**:
```javascript
async function togglePlugin(pluginName, enabled) {
    try {
        const response = await fetch('/api/plugins/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({plugin_name: pluginName, enabled: enabled})
        });
        const data = await response.json();
        if (data.success) {
            showToast(`${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}æˆåŠŸ`, 'success');
            await loadPlugins(); // âœ¨ æ–°å¢ï¼šé‡æ–°åŠ è½½æ’ä»¶åˆ—è¡¨
        } else {
            showToast(data.message || 'æ“ä½œå¤±è´¥', 'error');
            await loadPlugins(); // âœ¨ æ–°å¢ï¼šæ¢å¤æ­£ç¡®çŠ¶æ€
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯', 'error');
        await loadPlugins(); // âœ¨ æ–°å¢ï¼šæ¢å¤æ­£ç¡®çŠ¶æ€
    }
}
```

---

### 3. çˆ†ç‚¹ç›‘æµ‹æ’ä»¶ä¿®å¤

**æ–‡ä»¶**: `plugins/hotspot_monitor.py`

**é—®é¢˜**: æœåŠ¡å™¨è°ƒç”¨äº†`get_current_stats()`æ–¹æ³•ï¼Œä½†æ’ä»¶ä¸­æ²¡æœ‰å®šä¹‰

**ä¿®å¤**: æ·»åŠ ç¼ºå¤±çš„æ–¹æ³•
```python
def get_current_stats(self) -> Dict:
    """è·å–å½“å‰ç»Ÿè®¡æ•°æ®"""
    return {
        "danmaku_speed": round(self.current_stats["danmaku_speed"], 2),
        "gift_value_per_minute": round(self.current_stats["gift_value_per_minute"], 2),
        "sc_count_per_minute": round(self.current_stats["sc_count_per_minute"], 2),
        "guard_count_per_minute": round(self.current_stats["guard_count_per_minute"], 2),
        "is_hotspot": self.current_stats["is_hotspot"],
        "hotspot_type": self.current_stats["hotspot_type"],
        "hotspot_value": self.current_stats["hotspot_value"]
    }
```

---

### 4. WebSocketè¿æ¥ä¿®å¤

**æ–‡ä»¶**: `core/danmaku.py` (ç¬¬195è¡Œ)

**é—®é¢˜**: websockets 16.0ç‰ˆæœ¬ä¸­ï¼Œ`ClientConnection`å¯¹è±¡æ²¡æœ‰`closed`å±æ€§ï¼Œæ”¹ç”¨`state`å±æ€§

**ä¿®å¤**:
```python
# ä¿®æ”¹å‰
if self.ws and self.ws.closed:
    print("è®¤è¯å¤±è´¥ï¼Œè¿æ¥å·²å…³é—­")
    return False

# ä¿®æ”¹å
try:
    from websockets.protocol import State
    if self.ws and hasattr(self.ws, 'state') and self.ws.state != State.OPEN:
        print("è®¤è¯å¤±è´¥ï¼Œè¿æ¥å·²å…³é—­")
        return False
except ImportError:
    # å…¼å®¹æ—§ç‰ˆæœ¬ websockets
    if self.ws and hasattr(self.ws, 'closed') and self.ws.closed:
        print("è®¤è¯å¤±è´¥ï¼Œè¿æ¥å·²å…³é—­")
        return False
```

**è¯´æ˜**: å…¼å®¹websocketsæ–°æ—§ç‰ˆæœ¬ï¼Œä¼˜å…ˆä½¿ç”¨æ–°API

---

### 5. ç”¨æˆ·åˆ†æAPIä¿®å¤ â­ æ–°å¢

**æ–‡ä»¶**: `server.py`

**é—®é¢˜**: APIå‡½æ•°ä¸­åˆ›å»ºäº†æ–°çš„`PluginManager`å®ä¾‹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å…¨å±€å®ä¾‹ï¼Œå¯¼è‡´è·å–ä¸åˆ°å·²åŠ è½½çš„æ’ä»¶

**å½±å“çš„API**:
- `/api/analytics/global`
- `/api/analytics/user/{user_name}`
- `/api/analytics/memory/{user_name}`
- `/api/analytics/search`
- `/api/analytics/clear-old-data`
- `/api/checkin/stats`
- `/api/lottery/stats`

**ä¿®å¤ç¤ºä¾‹**:
```python
# ä¿®æ”¹å‰
@app.get("/api/analytics/global")
async def get_global_analytics():
    from core.plugin_system import PluginManager
    plugin_manager = PluginManager()  # âŒ åˆ›å»ºæ–°å®ä¾‹
    user_analytics_plugin = plugin_manager.get_plugin("ç”¨æˆ·åˆ†æ")
    if user_analytics_plugin:
        ...

# ä¿®æ”¹å
@app.get("/api/analytics/global")
async def get_global_analytics():
    # âœ… ä½¿ç”¨å…¨å±€å®ä¾‹
    user_analytics_plugin = plugin_manager.get_plugin("ç”¨æˆ·åˆ†æ")
    if user_analytics_plugin and user_analytics_plugin.enabled:
        ...
```

**è¯´æ˜**: 
1. ç§»é™¤äº†å±€éƒ¨`plugin_manager`å˜é‡
2. ç›´æ¥ä½¿ç”¨å…¨å±€`plugin_manager`å®ä¾‹
3. å¢åŠ äº†`enabled`çŠ¶æ€æ£€æŸ¥

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

```
backend/
â”œâ”€â”€ core/
â”‚   â””â”€â”€ danmaku.py                    âœ… ä¿®å¤WebSocket APIå…¼å®¹æ€§
â”œâ”€â”€ plugins/
â”‚   â”œâ”€â”€ user_analytics.py             âœ… ä¿®å¤äº‹ä»¶å¤„ç†æ–¹æ³•å
â”‚   â””â”€â”€ hotspot_monitor.py            âœ… æ·»åŠ get_current_statsæ–¹æ³•
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ index.html                    âœ… ä¿®å¤å‰ç«¯çŠ¶æ€åŒæ­¥
â””â”€â”€ server.py                         âœ… ä¿®å¤APIä½¿ç”¨å…¨å±€plugin_manager (7ä¸ªAPI)
```

---

## ğŸš€ ä½¿ç”¨è¯´æ˜

### 1. é‡å¯æœåŠ¡å™¨
```bash
# åœæ­¢å½“å‰è¿è¡Œçš„æœåŠ¡å™¨ (Ctrl+C)
# ç„¶åé‡æ–°å¯åŠ¨
cd C:\Users\Flycat\Desktop\stepAI\BililiveRobot\backend
python server.py
```

### 2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
- æŒ‰ `Ctrl + F5` å¼ºåˆ¶åˆ·æ–°é¡µé¢
- æˆ–è€…åœ¨å¼€å‘è€…å·¥å…·ä¸­æ¸…é™¤ç¼“å­˜

### 3. éªŒè¯åŠŸèƒ½

#### âœ… éªŒè¯WebSocketè¿æ¥
1. åœ¨å‰ç«¯è¾“å…¥æˆ¿é—´å·
2. ç‚¹å‡»"è¿æ¥"æŒ‰é’®
3. è§‚å¯Ÿæ—¥å¿—åº”æ˜¾ç¤ºï¼š
   ```
   WebSocket è¿æ¥æˆåŠŸ
   è®¤è¯åŒ…å·²å‘é€
   è®¤è¯å›å¤: {'code': 0}
   å·²è¿æ¥åˆ°ç›´æ’­é—´ [æˆ¿é—´å·]
   ```

#### âœ… éªŒè¯æ’ä»¶çŠ¶æ€æ˜¾ç¤º
1. è¿›å…¥"æ’ä»¶ç®¡ç†"é¡µé¢
2. åˆ‡æ¢ä»»æ„æ’ä»¶çš„å¼€å…³
3. ç¡®è®¤å¼€å…³çŠ¶æ€ç«‹å³æ›´æ–°ï¼ˆä¸éœ€è¦åˆ·æ–°é¡µé¢ï¼‰

#### âœ… éªŒè¯ç”¨æˆ·åˆ†ææ’ä»¶
1. ç¡®ä¿"ç”¨æˆ·åˆ†æ"æ’ä»¶å·²å¯ç”¨
2. åœ¨ç›´æ’­é—´å‘é€æµ‹è¯•å¼¹å¹•
3. è®¿é—® `/api/analytics/global` åº”è¿”å›ç»Ÿè®¡æ•°æ®ï¼ˆä¸æ˜¯"æœªå¯ç”¨"ï¼‰
4. å‰ç«¯"ç”¨æˆ·åˆ†æ"é¡µé¢åº”æ˜¾ç¤ºæ•°æ®

#### âœ… éªŒè¯çˆ†ç‚¹ç›‘æµ‹æ’ä»¶
1. ç¡®ä¿"çˆ†ç‚¹ç›‘æµ‹"æ’ä»¶å·²å¯ç”¨
2. è§‚å¯Ÿå‰ç«¯æ˜¯å¦æ˜¾ç¤ºçˆ†ç‚¹ç»Ÿè®¡æ•°æ®
3. æ£€æŸ¥æ—¥å¿—æ— æŠ¥é”™

---

## ğŸ“Š é¢„æœŸç»“æœ

### æˆåŠŸæ ‡å¿—
- âœ… WebSocketè¿æ¥æˆåŠŸï¼Œèƒ½æ¥æ”¶å¼¹å¹•
- âœ… æ’ä»¶å¼€å…³çŠ¶æ€æ­£ç¡®æ˜¾ç¤º
- âœ… ç”¨æˆ·åˆ†ææ’ä»¶è®°å½•å¼¹å¹•æ•°æ®
- âœ… ç”¨æˆ·åˆ†æAPIè¿”å›æ­£ç¡®æ•°æ®ï¼ˆä¸å†æç¤º"æœªå¯ç”¨"ï¼‰
- âœ… çˆ†ç‚¹ç›‘æµ‹æ’ä»¶æ­£å¸¸ç»Ÿè®¡
- âœ… æ—¥å¿—ä¸­æ— AttributeErroræˆ–æ–¹æ³•ç¼ºå¤±é”™è¯¯

### æ—¥å¿—ç¤ºä¾‹ï¼ˆæ­£å¸¸ï¼‰
```
2026-02-05 23:XX:XX - server - INFO - æ­£åœ¨åŠ è½½æ’ä»¶...
2026-02-05 23:XX:XX - plugin.ç”¨æˆ·åˆ†æ - INFO - æ’ä»¶ ç”¨æˆ·åˆ†æ åˆå§‹åŒ–
2026-02-05 23:XX:XX - server - INFO - æ’ä»¶åŠ è½½å®Œæˆ
2026-02-05 23:XX:XX - server - INFO - å¼¹å¹•å‘é€å™¨å·²åˆå§‹åŒ–ï¼Œæˆ¿é—´å·: XXXXXX
2026-02-05 23:XX:XX - server - INFO - WebSocket è¿æ¥æˆåŠŸ
2026-02-05 23:XX:XX - server - INFO - å·²è¿æ¥åˆ°ç›´æ’­é—´ XXXXXX
```

### APIæµ‹è¯•ç¤ºä¾‹
```bash
# æµ‹è¯•ç”¨æˆ·åˆ†æAPI
curl http://localhost:8000/api/analytics/global

# åº”è¿”å›ï¼ˆä¿®å¤åï¼‰
{
  "success": true,
  "data": {
    "total_messages": 0,
    "total_users": 0,
    ...
  }
}
```

---

## ğŸ”§ æŠ€æœ¯è¯´æ˜

### 1. PluginBaseEnhanced æ¨¡æ¿æ–¹æ³•æ¨¡å¼
```
åŸºç±» (PluginBaseEnhanced)
â”œâ”€â”€ on_danmaku()           â† å¯¹å¤–æ¥å£ï¼Œæ·»åŠ æ€§èƒ½ç›‘æ§
â”‚   â””â”€â”€ _on_danmaku_impl() â† å­ç±»é‡å†™æ­¤æ–¹æ³•
â””â”€â”€ on_gift()
    â””â”€â”€ _on_gift_impl()
```

**ä¼˜ç‚¹**:
- ç»Ÿä¸€çš„æ€§èƒ½ç›‘æ§
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- ä»£ç å¤ç”¨

### 2. websockets APIå˜åŒ–
| ç‰ˆæœ¬ | API | è¯´æ˜ |
|------|-----|------|
| < 11.0 | `ws.closed` | å¸ƒå°”å€¼ |
| >= 11.0 | `ws.state` | Stateæšä¸¾ (CONNECTING/OPEN/CLOSING/CLOSED) |

### 3. å‰ç«¯çŠ¶æ€ç®¡ç†ç­–ç•¥
- **ä¹è§‚æ›´æ–°**: æ“ä½œåç«‹å³æ›´æ–°UI
- **æœåŠ¡å™¨åŒæ­¥**: é‡æ–°åŠ è½½ç¡®ä¿çŠ¶æ€ä¸€è‡´
- **é”™è¯¯å›æ»š**: å¤±è´¥æ—¶æ¢å¤æ­£ç¡®çŠ¶æ€

### 4. PluginManagerå•ä¾‹æ¨¡å¼
```python
# âŒ é”™è¯¯ï¼šæ¯æ¬¡åˆ›å»ºæ–°å®ä¾‹
def api_function():
    plugin_manager = PluginManager()
    
# âœ… æ­£ç¡®ï¼šä½¿ç”¨å…¨å±€å•ä¾‹
plugin_manager = PluginManager()  # å…¨å±€åˆ›å»ºä¸€æ¬¡

def api_function():
    plugin = plugin_manager.get_plugin("xxx")
```

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

```desktop-local-file
{
"localPath": "C:\\Users\\Flycat\\Desktop\\stepAI\\BililiveRobot\\backend\\æ’ä»¶ä¿®å¤æŠ¥å‘Š.md",
"fileName": "æ’ä»¶ä¿®å¤æŠ¥å‘Š.md"
}
```

```desktop-local-file
{
"localPath": "C:\\Users\\Flycat\\Desktop\\stepAI\\BililiveRobot\\backend\\WebSocketè¿æ¥ä¿®å¤æŠ¥å‘Š.md",
"fileName": "WebSocketè¿æ¥ä¿®å¤æŠ¥å‘Š.md"
}
```

```desktop-local-file
{
"localPath": "C:\\Users\\Flycat\\Desktop\\stepAI\\BililiveRobot\\backend\\ç”¨æˆ·åˆ†ææœªå¯ç”¨é—®é¢˜ä¿®å¤.md",
"fileName": "ç”¨æˆ·åˆ†ææœªå¯ç”¨é—®é¢˜ä¿®å¤.md"
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¾èµ–ç‰ˆæœ¬**: ç¡®ä¿å®‰è£…äº†æ­£ç¡®çš„ä¾èµ–ç‰ˆæœ¬
   ```bash
   pip install -r requirements.txt
   ```

2. **Pythonç‰ˆæœ¬**: å»ºè®®ä½¿ç”¨Python 3.11+

3. **ç«¯å£å ç”¨**: ç¡®ä¿8000ç«¯å£æœªè¢«å ç”¨

4. **æ—¥å¿—ç›‘æ§**: å¯åŠ¨åè§‚å¯Ÿæ—¥å¿—ï¼Œç¡®è®¤æ— é”™è¯¯

---

## ğŸ‰ æ€»ç»“

æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼ä¸»è¦ä¿®å¤äº†ï¼š
1. âœ… ç”¨æˆ·åˆ†ææ’ä»¶çš„äº‹ä»¶å¤„ç†æœºåˆ¶
2. âœ… å‰ç«¯æ’ä»¶çŠ¶æ€åŒæ­¥é€»è¾‘
3. âœ… çˆ†ç‚¹ç›‘æµ‹æ’ä»¶çš„ç¼ºå¤±æ–¹æ³•
4. âœ… WebSocketåº“ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜
5. âœ… ç”¨æˆ·åˆ†æAPIçš„PluginManagerå®ä¾‹é—®é¢˜ â­

ç°åœ¨æ‚¨å¯ä»¥ï¼š
- æ­£å¸¸è¿æ¥ç›´æ’­é—´
- æ’ä»¶çŠ¶æ€æ­£ç¡®æ˜¾ç¤º
- ç”¨æˆ·åˆ†æåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- ç”¨æˆ·åˆ†æAPIæ­£å¸¸è¿”å›æ•°æ®
- çˆ†ç‚¹ç›‘æµ‹åŠŸèƒ½æ­£å¸¸å·¥ä½œ

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶æˆ–è”ç³»æŠ€æœ¯æ”¯æŒï¼
