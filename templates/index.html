<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bç«™ç›´æ’­å¼¹å¹•å·¥å…· - é«˜çº§ç‰ˆ</title>
    <style>
        /* ==================== CSS å˜é‡ç³»ç»Ÿ ==================== */
        :root {
            /* ä¸»è‰²è°ƒ - ç°ä»£æ¸å˜ç´« */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --primary-dark: #764ba2;
            --primary-light: #8b9ff0;

            /* åŠŸèƒ½è‰² */
            --success-color: #10b981;
            --success-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            --warning-color: #f59e0b;
            --warning-gradient: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            --danger-color: #ef4444;
            --danger-gradient: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            --info-color: #3b82f6;
            --info-gradient: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);

            /* èƒŒæ™¯è‰² - æ‰å¹³åŒ–æµ…è‰² */
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-tertiary: #e2e8f0;
            --bg-card: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.95);

            /* æ–‡å­—è‰² */
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --text-white: #ffffff;

            /* è¾¹æ¡†è‰² */
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --border-dark: #94a3b8;

            /* é˜´å½± - æŸ”å’Œå¤šå±‚ */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --shadow-glow: 0 0 20px rgba(102, 126, 234, 0.3);

            /* åœ†è§’ - åœ†æ¶¦è®¾è®¡ */
            --radius-xs: 4px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-2xl: 32px;
            --radius-full: 9999px;

            /* é—´è· */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;

            /* è¿‡æ¸¡ */
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
            --transition-slow: 350ms ease;

            /* å­—ä½“ */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        /* ==================== å…¨å±€é‡ç½® ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ==================== é¡¶éƒ¨å¯¼èˆªæ  ==================== */
        .navbar {
            background: var(--primary-gradient);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: var(--text-white);
            padding: var(--spacing-md) var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .navbar-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .navbar-logo-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .navbar-menu {
            display: flex;
            gap: var(--spacing-sm);
            list-style: none;
            background: rgba(255, 255, 255, 0.1);
            padding: var(--spacing-xs);
            border-radius: var(--radius-xl);
            backdrop-filter: blur(10px);
        }

        .navbar-menu-item {
            cursor: pointer;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            transition: all var(--transition-base);
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .navbar-menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0);
            transition: transform var(--transition-base);
            border-radius: var(--radius-full);
        }

        .navbar-menu-item:hover::before {
            transform: scale(1);
        }

        .navbar-menu-item.active {
            background: rgba(255, 255, 255, 0.25);
            font-weight: 600;
        }

        /* ==================== ä¸»å®¹å™¨ ==================== */
        .container {
            max-width: 1400px;
            margin: var(--spacing-xl) auto;
            padding: 0 var(--spacing-lg);
        }

        /* ==================== å¡ç‰‡æ ·å¼ ==================== */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-medium);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .card-title-icon {
            width: 28px;
            height: 28px;
            background: var(--primary-gradient);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        /* ==================== æŒ‰é’®æ ·å¼ ==================== */
        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-full);
            border: none;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition-base);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            position: relative;
            overflow: hidden;
            font-family: var(--font-family);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(rgba(255, 255, 255, 0.2), transparent);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .btn:hover::before {
            opacity: 1;
        }
        
        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-md);
            font-size: 0.85rem;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: var(--text-white);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .btn-success {
            background: var(--success-gradient);
            color: var(--text-white);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5);
        }

        .btn-danger {
            background: var(--danger-gradient);
            color: var(--text-white);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-dark);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-icon {
            padding: var(--spacing-sm);
            border-radius: var(--radius-full);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ==================== è¾“å…¥æ¡†æ ·å¼ ==================== */
        .input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            transition: all var(--transition-base);
            background: var(--bg-card);
            font-family: var(--font-family);
        }

        .input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .input::placeholder {
            color: var(--text-tertiary);
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            transition: all var(--transition-base);
            font-family: var(--font-family);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* ==================== ç½‘æ ¼å¸ƒå±€ ==================== */
        .grid {
            display: grid;
            gap: var(--spacing-md);
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .grid-5 {
            grid-template-columns: repeat(5, 1fr);
        }

        /* ä¸»å†…å®¹åŒº + ä¾§è¾¹æ  */
        .grid-sidebar-left {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: var(--spacing-lg);
        }

        .grid-sidebar-right {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: var(--spacing-lg);
        }

        @media (max-width: 1200px) {
            .grid-sidebar-left,
            .grid-sidebar-right {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4, .grid-5 {
                grid-template-columns: 1fr;
            }

            .navbar-menu {
                display: none;
            }

            .container {
                padding: 0 var(--spacing-md);
            }
        }

        /* ==================== ç»Ÿè®¡å¡ç‰‡ ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }

        .stat-card {
            background: var(--primary-gradient);
            color: var(--text-white);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.08) 0%, transparent 70%);
            border-radius: 50%;
        }

        .stat-card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: var(--shadow-lg);
        }

        .stat-card.success {
            background: var(--success-gradient);
        }

        .stat-card.warning {
            background: var(--warning-gradient);
        }

        .stat-card.danger {
            background: var(--danger-gradient);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.95;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            position: relative;
        }

        /* ==================== å¼¹å¹•å®¹å™¨ ==================== */
        .danmaku-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            height: 500px;
            overflow-y: auto;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            position: relative;
        }

        .danmaku-container::-webkit-scrollbar {
            width: 6px;
        }

        .danmaku-container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: var(--radius-full);
        }

        .danmaku-container::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: var(--radius-full);
        }

        .danmaku-container::-webkit-scrollbar-thumb:hover {
            background: var(--border-dark);
        }

        /* ==================== å¼¹å¹•æ¡ç›® ==================== */
        .danmaku-item {
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            border-left: 3px solid var(--primary-color);
            transition: all var(--transition-base);
            animation: slideInLeft 0.3s ease;
            position: relative;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-15px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .danmaku-item:hover {
            transform: translateX(3px);
            box-shadow: var(--shadow-sm);
            background: var(--bg-card);
        }

        .danmaku-item.gift {
            border-left-color: #ffd700;
            background: linear-gradient(to right, #fffbeb, #fef3c7);
        }

        .danmaku-item.superchat {
            border-left-color: var(--danger-color);
            background: linear-gradient(to right, #fef2f2, #fee2e2);
        }

        .danmaku-item.guard {
            border-left-color: #9b59b6;
            background: linear-gradient(to right, #faf5ff, #f3e8ff);
        }

        .danmaku-item.ai-reply {
            border-left-color: var(--success-color);
            background: linear-gradient(to right, #ecfdf5, #d1fae5);
        }

        .danmaku-item.ai-reply .danmaku-content {
            font-weight: 600;
            color: #059669;
        }

        .danmaku-item.interact {
            border-left-color: var(--info-color);
            background: linear-gradient(to right, #eff6ff, #dbeafe);
        }

        .danmaku-item.follow {
            border-left-color: #ef4444;
            background: linear-gradient(to right, #fef2f2, #fee2e2);
        }

        .danmaku-item.filtered {
            opacity: 0.6;
            border-left-color: #f59e0b;
            background: linear-gradient(to right, #fffbeb, #fef3c7);
        }

        .filter-reason, .filter-mark {
            color: #f59e0b;
            font-size: 0.85rem;
            font-style: italic;
        }

        .danmaku-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
        }

        .danmaku-user {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.85rem;
        }

        .danmaku-time {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-left: auto;
            font-weight: 500;
        }

        .danmaku-content {
            color: var(--text-primary);
            word-wrap: break-word;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .medal {
            display: inline-block;
            padding: 1px var(--spacing-xs);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--warning-gradient);
            color: var(--text-white);
        }

        /* ==================== Toast æç¤º ==================== */
        .toast-container {
            position: fixed;
            top: 100px;
            right: var(--spacing-xl);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .toast {
            background: var(--bg-card);
            padding: var(--spacing-lg) var(--spacing-xl);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            min-width: 320px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.success {
            border-left-color: var(--success-color);
        }

        .toast.error {
            border-left-color: var(--danger-color);
        }

        .toast.warning {
            border-left-color: var(--warning-color);
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-message {
            flex: 1;
            font-weight: 500;
        }

        /* ==================== åŠ è½½åŠ¨ç”» ==================== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ==================== é¡µé¢åˆ‡æ¢ ==================== */
        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ==================== æ¨¡æ€æ¡† ==================== */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            padding: var(--spacing-2xl);
            border-radius: var(--radius-2xl);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: scaleIn 0.3s ease;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-tertiary);
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-base);
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            transition: all var(--transition-base);
            font-family: var(--font-family);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        /* ==================== æ’ä»¶å¡ç‰‡ ==================== */
        .plugin-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }

        .plugin-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
        }

        .plugin-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .plugin-card.disabled::before {
            background: var(--border-light);
        }

        .plugin-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }

        .plugin-info {
            flex: 1;
        }

        .plugin-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .plugin-version {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .plugin-description {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .plugin-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border-light);
        }

        .plugin-author {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        /* ==================== å¼€å…³ ==================== */
        .switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-dark);
            transition: var(--transition-base);
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition-base);
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }

        input:checked + .slider {
            background: var(--success-gradient);
        }

        input:checked + .slider:before {
            transform: translateX(28px);
        }

        /* ==================== çŠ¶æ€å¾½ç«  ==================== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-badge.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-badge.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .status-badge.danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .status-badge.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info-color);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-badge.success .status-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* ==================== åº•éƒ¨çŠ¶æ€æ  ==================== */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-light);
            padding: var(--spacing-md) var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* ==================== å“åº”å¼è°ƒæ•´ ==================== */
        @media (max-width: 768px) {
            .stat-value {
                font-size: 2rem;
            }

            .card {
                padding: var(--spacing-lg);
            }

            .btn {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-logo">
                <div class="navbar-logo-icon">ğŸ“º</div>
                <span>Bç«™ç›´æ’­å¼¹å¹•å·¥å…·</span>
            </div>
            <ul class="navbar-menu">
                <li class="navbar-menu-item active" data-page="monitor">å¼¹å¹•ç›‘æ§</li>
                <li class="navbar-menu-item" data-page="analytics">ç”¨æˆ·åˆ†æ</li>
                <li class="navbar-menu-item" data-page="login">ç™»å½•è®¾ç½®</li>
                <li class="navbar-menu-item" data-page="plugins">æ’ä»¶ç®¡ç†</li>
            </ul>
        </div>
    </nav>

    <!-- Toast å®¹å™¨ -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- å¼¹å¹•ç›‘æ§é¡µé¢ -->
        <div class="page active" id="page-monitor">
            <!-- ç™»å½•çŠ¶æ€å’Œç›´æ’­é—´ä¿¡æ¯ -->
            <div class="grid grid-2" style="margin-top: var(--spacing-lg);">
                <!-- ç™»å½•çŠ¶æ€ -->
                <div class="card">
                    <div class="card-title">
                        <div class="card-title-icon">ğŸ”</div>
                        è´¦æˆ·ä¿¡æ¯
                    </div>
                    <div id="monitorLoginStatus">
                        <p style="color: var(--text-secondary);">æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€...</p>
                    </div>
                </div>

                <!-- ç›´æ’­é—´ä¿¡æ¯ -->
                <div class="card">
                    <div class="card-title">
                        <div class="card-title-icon">ğŸ“¡</div>
                        ç›´æ’­é—´ä¿¡æ¯
                        <button class="btn btn-secondary btn-sm" id="refreshRoomInfoBtn" style="margin-left: auto; display: none;" onclick="refreshRoomInfo()">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    <div id="roomInfo">
                        <div class="status-badge warning">
                            <span class="status-dot"></span>
                            æœªè¿æ¥ç›´æ’­é—´
                        </div>
                        <div id="roomInfoDetails" style="display: none; margin-top: var(--spacing-md);">
                            <!-- æ ¸å¿ƒæ•°æ®å¡ç‰‡ -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                                <!-- ä¸»æ’­ä¿¡æ¯ -->
                                <div style="padding: var(--spacing-md); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: var(--radius-lg); color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                                    <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: var(--spacing-xs);">ğŸ‘¤ ä¸»æ’­</div>
                                    <div style="font-size: 1.4em; font-weight: 700; margin-bottom: var(--spacing-xs); line-height: 1.2; min-height: 1.8em;" id="anchorName">åŠ è½½ä¸­...</div>
                                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); font-size: 0.85em; opacity: 0.95;">
                                        <span id="anchorLevel" style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px;"></span>
                                        <span style="opacity: 0.7;">â€¢</span>
                                        <span style="font-size: 0.9em;">UID: <span id="anchorUid">-</span></span>
                                    </div>
                                </div>
                                
                                <!-- åœ¨çº¿äººæ•° -->
                                <div style="padding: var(--spacing-md); background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: var(--radius-lg); color: white; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);">
                                    <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: var(--spacing-xs);">ğŸ‘¥ åœ¨çº¿äººæ°”</div>
                                    <div style="font-size: 2.2em; font-weight: 700; line-height: 1.1; margin-bottom: var(--spacing-xs);" id="onlineCount">-</div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">å®æ—¶è§‚çœ‹</div>
                                </div>
                            </div>
                            
                            <!-- ç›´æ’­æ ‡é¢˜ -->
                            <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: var(--radius-lg); color: white; box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);">
                                <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: var(--spacing-xs);">ğŸ“º ç›´æ’­æ ‡é¢˜</div>
                                <div style="font-weight: 600; font-size: 1.15em; line-height: 1.4;" id="roomTitle">åŠ è½½ä¸­...</div>
                            </div>
                            
                            <!-- è¯¦ç»†ä¿¡æ¯ç½‘æ ¼ -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                                <div style="padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px;">ğŸ  æˆ¿é—´å·</div>
                                    <div style="font-weight: 600; font-size: 0.95em;" id="currentRoom">-</div>
                                </div>
                                <div style="padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px;">ğŸ¬ çŠ¶æ€</div>
                                    <div style="font-weight: 600; font-size: 0.95em;" id="liveStatus">-</div>
                                </div>
                                <div style="padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px;">â±ï¸ æ—¶é•¿</div>
                                    <div style="font-weight: 600; font-size: 0.95em;" id="liveDuration">-</div>
                                </div>
                                <div style="padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px;">ğŸ·ï¸ åˆ†åŒº</div>
                                    <div style="font-weight: 600; font-size: 0.95em;" id="roomArea">-</div>
                                </div>
                            </div>
                            
                            <!-- ç»Ÿè®¡æ•°æ® -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-sm);">
                                <div style="text-align: center; padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                    <div style="font-size: 1.3em; font-weight: 700; color: #f5576c; margin-bottom: 4px;" id="followerCount">-</div>
                                    <div style="font-size: 0.75em; color: var(--text-secondary);">â¤ï¸ å…³æ³¨</div>
                                </div>
                                <div style="text-align: center; padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                    <div style="font-size: 1.3em; font-weight: 700; color: #667eea; margin-bottom: 4px;" id="userLevel">-</div>
                                    <div style="font-size: 0.75em; color: var(--text-secondary);">ğŸ–ï¸ ç­‰çº§</div>
                                </div>
                                <div style="text-align: center; padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px;">ğŸ·ï¸ æ ‡ç­¾</div>
                                    <div style="font-size: 0.85em; font-weight: 600; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" id="roomTags" title="">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç›´æ’­é—´è¾“å…¥ -->
            <div class="card" style="margin-top: var(--spacing-lg);">
                <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                    <input type="text" class="input" id="roomInput" placeholder="è¾“å…¥ç›´æ’­é—´å·æˆ–URL (ä¾‹å¦‚: 123456 æˆ– https://live.bilibili.com/123456)" style="flex: 1; min-width: 300px;">
                    <button class="btn btn-primary" id="connectBtn">
                        <span>è¿æ¥ç›´æ’­é—´</span>
                    </button>
                    <button class="btn btn-danger" id="disconnectBtn" style="display: none;">
                        <span>æ–­å¼€è¿æ¥</span>
                    </button>
                </div>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statOnline">0</div>
                    <div class="stat-label">åœ¨çº¿äººæ•°</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="statDanmaku">0</div>
                    <div class="stat-label">å¼¹å¹•æ€»æ•°</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="statSpeed">0</div>
                    <div class="stat-label">å¼¹å¹•é€Ÿåº¦ (æ¡/åˆ†)</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-value" id="statGift">Â¥0</div>
                    <div class="stat-label">ç¤¼ç‰©æ€»ä»·å€¼ <span id="statGiftCount" style="font-size: 0.75rem; color: var(--text-muted);">(0)</span></div>
                </div>
            </div>

            <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
            <div class="grid grid-sidebar-left" style="margin-top: var(--spacing-lg);">
                <!-- å¼¹å¹•æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="card">
                    <div class="card-title">
                        <div class="card-title-icon">ğŸ’¬</div>
                        å®æ—¶å¼¹å¹•
                    </div>
                    <div class="danmaku-container" id="danmakuContainer">
                        <div style="text-align: center; color: var(--text-secondary); padding: 3rem;">
                            <p style="font-size: 1.1rem; margin-bottom: var(--spacing-md);">ğŸ“¡ ç­‰å¾…è¿æ¥ç›´æ’­é—´...</p>
                            <p>è¿æ¥åå®æ—¶æ˜¾ç¤ºå¼¹å¹•</p>
                        </div>
                    </div>
                </div>

                <!-- ä¾§è¾¹æ  -->
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    <!-- çˆ†ç‚¹ç›‘æµ‹ -->
                    <div class="card">
                        <div class="card-title">
                            <div class="card-title-icon">ğŸ”¥</div>
                            çˆ†ç‚¹ç›‘æµ‹
                        </div>
                        <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: var(--text-secondary); font-size: 0.85rem;">å¼¹å¹•é€Ÿåº¦</span>
                                <span style="font-weight: 600; color: var(--primary-color);" id="hotspotDanmakuSpeed">0 æ¡/åˆ†</span>
                            </div>
                            <div style="height: 4px; background: var(--bg-secondary); border-radius: var(--radius-full); overflow: hidden;">
                                <div id="hotspotDanmakuBar" style="height: 100%; background: var(--primary-gradient); width: 0%; transition: width 0.3s;"></div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--spacing-sm);">
                                <span style="color: var(--text-secondary); font-size: 0.85rem;">ç¤¼ç‰©ä»·å€¼</span>
                                <span style="font-weight: 600; color: var(--success-color);" id="hotspotGiftValue">Â¥0</span>
                            </div>
                            <div style="height: 4px; background: var(--bg-secondary); border-radius: var(--radius-full); overflow: hidden;">
                                <div id="hotspotGiftBar" style="height: 100%; background: var(--success-gradient); width: 0%; transition: width 0.3s;"></div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--spacing-sm);">
                                <span style="color: var(--text-secondary); font-size: 0.85rem;">SCæ•°é‡</span>
                                <span style="font-weight: 600; color: var(--warning-color);" id="hotspotScCount">0 ä¸ª</span>
                            </div>
                            
                            <div id="hotspotStatus" style="margin-top: var(--spacing-sm); padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-md); text-align: center; font-size: 0.85rem; color: var(--text-tertiary);">
                                ç­‰å¾…æ•°æ®...
                            </div>
                        </div>
                    </div>

                    <!-- å®æ—¶æ´»åŠ¨ -->
                    <div class="card">
                        <div class="card-title">
                            <div class="card-title-icon">ğŸ“Š</div>
                            å®æ—¶æ´»åŠ¨
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm);">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--info-color);" id="activityGifts">0</div>
                                <div style="color: var(--text-tertiary); font-size: 0.75rem;">ç¤¼ç‰©æ•°</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger-color);" id="activityScs">0</div>
                                <div style="color: var(--text-tertiary); font-size: 0.75rem;">SCæ•°</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);" id="activityGuards">0</div>
                                <div style="color: var(--text-tertiary); font-size: 0.75rem;">ä¸Šèˆ°æ•°</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-color);" id="activityFollows">0</div>
                                <div style="color: var(--text-tertiary); font-size: 0.75rem;">å…³æ³¨æ•°</div>
                            </div>
                        </div>
                    </div>

                    <!-- AIåŠ©æ‰‹é¢æ¿ -->
                    <div class="card">
                        <div class="card-title">
                            <div class="card-title-icon">ğŸ¤–</div>
                            AIåŠ©æ‰‹
                        </div>
                        <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                            <div>
                                <label class="form-label">APIå¯†é’¥</label>
                                <input type="text" class="form-control" id="aiApiKey" placeholder="è¾“å…¥Moonshot API Key">
                            </div>
                            <div>
                                <label class="form-label">æ¨¡å‹</label>
                                <select class="form-control" id="aiModel">
                                    <option value="moonshot-v1-8k">moonshot-v1-8k</option>
                                    <option value="moonshot-v1-32k">moonshot-v1-32k</option>
                                    <option value="moonshot-v1-128k">moonshot-v1-128k</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">å›å¤æ¦‚ç‡</label>
                                <input type="range" class="form-control" id="aiReplyProbability" min="0" max="1" step="0.05" value="0.1">
                                <small style="color: var(--text-tertiary);">å½“å‰å€¼: <span id="probabilityValue">0.1</span></small>
                            </div>
                            <div>
                                <label class="form-label">åˆ›é€ æ€§</label>
                                <input type="range" class="form-control" id="aiTemperature" min="0" max="1" step="0.1" value="0.7">
                                <small style="color: var(--text-tertiary);">å½“å‰å€¼: <span id="temperatureValue">0.7</span></small>
                            </div>
                            <button class="btn btn-primary" id="saveAiConfig" style="width: 100%;">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>

                    <!-- å¿«æ·æ“ä½œ -->
                    <div class="card">
                        <div class="card-title">
                            <div class="card-title-icon">âš¡</div>
                            å¿«æ·æ“ä½œ
                        </div>
                        <div style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
                            <button class="btn btn-secondary" id="clearDanmaku">æ¸…ç©ºå¼¹å¹•</button>
                            <button class="btn btn-secondary" id="exportDanmaku">å¯¼å‡ºå¼¹å¹•</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ·åˆ†æé¡µé¢ -->
        <div class="page" id="page-analytics">
            <!-- å…¨å±€ç»Ÿè®¡ -->
            <div class="card" style="margin-bottom: var(--spacing-lg);">
                <div class="card-title">
                    <div class="card-title-icon">ğŸ“Š</div>
                    å…¨å±€ç»Ÿè®¡
                </div>
                <div class="grid grid-4">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);" id="analyticsTotalUsers">0</div>
                        <div style="color: var(--text-secondary);">æ´»è·ƒç”¨æˆ·</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success-color);" id="analyticsTotalMessages">0</div>
                        <div style="color: var(--text-secondary);">æ€»æ¶ˆæ¯æ•°</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--warning-color);" id="analyticsTodayUsers">0</div>
                        <div style="color: var(--text-secondary);">ä»Šæ—¥æ´»è·ƒ</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--danger-color);" id="analyticsTopInterest">-</div>
                        <div style="color: var(--text-secondary);">çƒ­é—¨è¯é¢˜</div>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·æœç´¢ -->
            <div class="card" style="margin-bottom: var(--spacing-lg);">
                <div class="card-title">
                    <div class="card-title-icon">ğŸ”</div>
                    ç”¨æˆ·æœç´¢
                </div>
                <div style="display: flex; gap: var(--spacing-md);">
                    <input type="text" class="input" id="userSearchInput" placeholder="è¾“å…¥ç”¨æˆ·åæœç´¢...">
                    <button class="btn btn-primary" id="searchUserBtn">æœç´¢</button>
                </div>
            </div>

            <!-- ç”¨æˆ·ç”»åƒ -->
            <div class="card" id="userProfileCard" style="display: none;">
                <div class="card-title">
                    <div class="card-title-icon">ğŸ‘¤</div>
                    ç”¨æˆ·ç”»åƒ
                </div>
                <div id="userProfileContent"></div>
            </div>

            <!-- ç”¨æˆ·è®°å¿† -->
            <div class="card" id="userMemoryCard" style="display: none;">
                <div class="card-title">
                    <div class="card-title-icon">ğŸ§ </div>
                    ç”¨æˆ·è®°å¿†
                </div>
                <div id="userMemoryContent"></div>
            </div>

            <!-- å…´è¶£æœç´¢ -->
            <div class="card" style="margin-top: var(--spacing-lg);">
                <div class="card-title">
                    <div class="card-title-icon">ğŸ¯</div>
                    å…´è¶£æœç´¢
                </div>
                <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                    <input type="text" class="input" id="interestSearchInput" placeholder="è¾“å…¥å…´è¶£å…³é”®è¯...">
                    <button class="btn btn-primary" id="searchInterestBtn">æœç´¢</button>
                </div>
                <div id="interestSearchResults"></div>
            </div>
        </div>

        <!-- ç™»å½•è®¾ç½®é¡µé¢ -->
        <div class="page" id="page-login">
            <div class="card">
                <div class="card-title">
                    <div class="card-title-icon">ğŸ”‘</div>
                    ç™»å½•è®¾ç½®
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-xl);">
                    <div>
                        <h3 style="margin-bottom: var(--spacing-lg);">æ‰«ç ç™»å½•</h3>
                        <div id="qrcodeArea" style="text-align: center; padding: var(--spacing-xl); background: var(--bg-secondary); border-radius: var(--radius-xl);">
                            <div id="qrcodeImage" style="width: 200px; height: 200px; margin: var(--spacing-md) auto; display: flex; align-items: center; justify-content: center; background: white; border-radius: var(--radius-lg); border: 2px solid var(--border-light);">
                                <span style="color: var(--text-tertiary);">ç‚¹å‡»ç”ŸæˆäºŒç»´ç </span>
                            </div>
                            <button class="btn btn-primary" id="generateQrcode" style="margin-top: var(--spacing-md);">ç”ŸæˆäºŒç»´ç </button>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: var(--spacing-lg);">ç™»å½•çŠ¶æ€</h3>
                        <div id="loginStatusArea">
                            <p style="color: var(--text-secondary);">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç™»å½•</p>
                        </div>
                        <div style="margin-top: var(--spacing-xl);">
                            <button class="btn btn-danger" id="logoutBtn" style="display: none;">é€€å‡ºç™»å½•</button>
                            <button class="btn btn-secondary" id="anonymousBtn">ä½¿ç”¨åŒ¿åæ¨¡å¼</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ’ä»¶ç®¡ç†é¡µé¢ -->
        <div class="page" id="page-plugins">
            <div class="card">
                <div class="card-title">
                    <div class="card-title-icon">ğŸ”Œ</div>
                    æ’ä»¶ç®¡ç†
                </div>
                <div class="grid grid-3" id="pluginList">
                    <p style="color: var(--text-secondary);">æ­£åœ¨åŠ è½½æ’ä»¶...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="status-item">
            <span class="status-dot" id="connectionDot"></span>
            <span id="connectionStatus">æœªè¿æ¥</span>
        </div>
        <div class="status-item">
            <span>ğŸ“Š</span>
            <span id="roomStatus">æœªè¿æ¥ç›´æ’­é—´</span>
        </div>
        <div class="status-item">
            <span>â±ï¸</span>
            <span id="uptime">è¿è¡Œæ—¶é—´: 00:00:00</span>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†å®¹å™¨ -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">æ’ä»¶é…ç½®</div>
                <div class="modal-close" id="modalClose">âœ•</div>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
        </div>
    </div>

    <script>
        // ==================== WebSocket è¿æ¥ ====================
        let ws = null;
        let isConnected = false;
        let danmakuCount = 0;
        let startTime = Date.now();
        let currentRoomId = null;
        let reconnectTimer = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectInterval = 3000;
        
        // é¡µé¢å¯è§æ€§çŠ¶æ€
        let isPageVisible = true;
        
        // å­˜å‚¨è¿æ¥çŠ¶æ€åˆ°sessionStorage
        function saveConnectionState() {
            if (isConnected && currentRoomId) {
                sessionStorage.setItem('ws_room_id', currentRoomId);
                sessionStorage.setItem('ws_was_connected', 'true');
                sessionStorage.setItem('ws_last_activity', Date.now().toString());
            }
        }
        
        // ä»sessionStorageæ¢å¤è¿æ¥çŠ¶æ€
        function restoreConnectionState() {
            const savedRoomId = sessionStorage.getItem('ws_room_id');
            const wasConnected = sessionStorage.getItem('ws_was_connected') === 'true';
            const lastActivity = parseInt(sessionStorage.getItem('ws_last_activity') || '0');
            
            // å¦‚æœ5åˆ†é’Ÿå†…æœ‰è¿‡è¿æ¥ï¼Œè‡ªåŠ¨é‡è¿
            if (savedRoomId && wasConnected && (Date.now() - lastActivity < 300000)) {
                console.log('[WebSocket] æ¢å¤è¿æ¥çŠ¶æ€ï¼Œæˆ¿é—´ID:', savedRoomId);
                return parseInt(savedRoomId);
            }
            return null;
        }
        
        // æ¸…ç†è¿æ¥çŠ¶æ€
        function clearConnectionState() {
            sessionStorage.removeItem('ws_room_id');
            sessionStorage.removeItem('ws_was_connected');
            sessionStorage.removeItem('ws_last_activity');
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        
        // è·å–å¹¶æ˜¾ç¤ºç›´æ’­é—´è¯¦ç»†ä¿¡æ¯
        async function loadRoomInfo(roomId) {
            console.log('[ç›´æ’­é—´ä¿¡æ¯] å¼€å§‹åŠ è½½æˆ¿é—´ä¿¡æ¯ï¼Œæˆ¿é—´å·:', roomId);
            
            try {
                const response = await fetch(`/api/room/info/${roomId}`);
                const data = await response.json();
                
                console.log('[ç›´æ’­é—´ä¿¡æ¯] APIå“åº”:', data);
                
                if (data.success) {
                    const roomData = data.data;
                    console.log('[ç›´æ’­é—´ä¿¡æ¯] æˆ¿é—´æ•°æ®:', roomData);
                    
                    // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯åŒºåŸŸ
                    const detailsDiv = document.getElementById('roomInfoDetails');
                    const refreshBtn = document.getElementById('refreshRoomInfoBtn');
                    
                    console.log('[ç›´æ’­é—´ä¿¡æ¯] è¯¦ç»†ä¿¡æ¯åŒºåŸŸå…ƒç´ :', detailsDiv);
                    console.log('[ç›´æ’­é—´ä¿¡æ¯] åˆ·æ–°æŒ‰é’®å…ƒç´ :', refreshBtn);
                    
                    if (detailsDiv) {
                        detailsDiv.style.display = 'block';
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] å·²æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯åŒºåŸŸ');
                    } else {
                        console.error('[ç›´æ’­é—´ä¿¡æ¯] æ‰¾ä¸åˆ°è¯¦ç»†ä¿¡æ¯åŒºåŸŸå…ƒç´ ï¼');
                    }
                    
                    if (refreshBtn) {
                        refreshBtn.style.display = 'inline-flex';
                    }
                    
                    // æ›´æ–°ä¸»æ’­ä¿¡æ¯
                    const anchorName = document.getElementById('anchorName');
                    const anchorLevel = document.getElementById('anchorLevel');
                    const anchorUid = document.getElementById('anchorUid');
                    const userLevel = document.getElementById('userLevel');
                    
                    // ä¸»æ’­UIDï¼ˆå…ˆè®¾ç½®ï¼Œå› ä¸ºä¸€å®šæœ‰ï¼‰
                    const uid = roomData.anchor?.uid || roomData.uid || 0;
                    if (anchorUid) {
                        anchorUid.textContent = uid || '-';
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] ä¸»æ’­UID:', uid);
                    }
                    
                    // ä¸»æ’­åç§°ï¼šç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æ•°æ®
                    let displayName = 'æœªçŸ¥ä¸»æ’­';
                    if (roomData.anchor && roomData.anchor.uname) {
                        displayName = roomData.anchor.uname;
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] ä¸»æ’­å:', displayName);
                    } else {
                        console.warn('[ç›´æ’­é—´ä¿¡æ¯] åç«¯æœªè¿”å›ä¸»æ’­åï¼ŒUID:', uid);
                        displayName = uid ? `ä¸»æ’­${uid}` : 'æœªçŸ¥ä¸»æ’­';
                    }
                    
                    if (anchorName) {
                        anchorName.textContent = displayName;
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] å·²æ›´æ–°ä¸»æ’­åç§°æ˜¾ç¤º:', displayName);
                    }
                    
                    // ä¸»æ’­ç­‰çº§
                    const anchorLevelValue = roomData.anchor?.level || 0;
                    if (anchorLevel) {
                        anchorLevel.textContent = anchorLevelValue ? `Lv${anchorLevelValue}` : '';
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] ä¸»æ’­ç­‰çº§:', anchorLevelValue);
                    }
                    
                    // ç”¨æˆ·ç­‰çº§ï¼ˆæ˜¾ç¤ºåœ¨ç»Ÿè®¡åŒºï¼‰
                    if (userLevel) {
                        userLevel.textContent = anchorLevelValue ? `Lv${anchorLevelValue}` : '-';
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] ç»Ÿè®¡åŒºç­‰çº§:', anchorLevelValue);
                    }
                    
                    // æ›´æ–°æˆ¿é—´åŸºæœ¬ä¿¡æ¯
                    const currentRoom = document.getElementById('currentRoom');
                    const roomTitle = document.getElementById('roomTitle');
                    
                    if (currentRoom) {
                        currentRoom.textContent = roomData.room_id || roomId;
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] æˆ¿é—´å·:', roomData.room_id);
                    }
                    
                    if (roomTitle) {
                        roomTitle.textContent = roomData.title || 'æœªè®¾ç½®æ ‡é¢˜';
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] ç›´æ’­æ ‡é¢˜:', roomData.title);
                    }
                    
                    // æ›´æ–°ç›´æ’­çŠ¶æ€
                    const liveStatus = document.getElementById('liveStatus');
                    const liveDuration = document.getElementById('liveDuration');
                    
                    if (liveStatus) {
                        const statusMap = {
                            0: 'âŒ æœªå¼€æ’­',
                            1: 'ğŸ”´ ç›´æ’­ä¸­',
                            2: 'ğŸ”„ è½®æ’­ä¸­'
                        };
                        liveStatus.innerHTML = statusMap[roomData.live_status] || 'æœªçŸ¥';
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] ç›´æ’­çŠ¶æ€:', roomData.live_status);
                    }
                    
                    if (liveDuration) {
                        liveDuration.textContent = roomData.live_duration_formatted || 'æœªå¼€æ’­';
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] ç›´æ’­æ—¶é•¿:', roomData.live_duration_formatted);
                    }
                    
                    // æ›´æ–°åœ¨çº¿äººæ•°
                    const onlineCount = document.getElementById('onlineCount');
                    if (onlineCount) {
                        const online = roomData.online || 0;
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] åœ¨çº¿äººæ•°åŸå§‹å€¼:', online);
                        if (online > 10000) {
                            onlineCount.textContent = `${(online / 10000).toFixed(1)}ä¸‡`;
                        } else {
                            onlineCount.textContent = online.toLocaleString();
                        }
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] åœ¨çº¿äººæ•°æ˜¾ç¤º:', onlineCount.textContent);
                    }
                    
                    // æ›´æ–°åˆ†åŒº
                    const roomArea = document.getElementById('roomArea');
                    if (roomArea) {
                        const area = roomData.parent_area_name && roomData.area_name 
                            ? `${roomData.parent_area_name} > ${roomData.area_name}`
                            : (roomData.area_name || 'æœªçŸ¥');
                        roomArea.textContent = area;
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] åˆ†åŒº:', area);
                    }
                    
                    // æ›´æ–°å…³æ³¨æ•°
                    const followerCount = document.getElementById('followerCount');
                    if (followerCount) {
                        const followers = roomData.anchor?.follower_num || roomData.attention || 0;
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] å…³æ³¨æ•°åŸå§‹å€¼:', followers);
                        if (followers > 10000) {
                            followerCount.textContent = `${(followers / 10000).toFixed(1)}ä¸‡`;
                        } else {
                            followerCount.textContent = followers.toLocaleString();
                        }
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] å…³æ³¨æ•°æ˜¾ç¤º:', followerCount.textContent);
                    }
                    
                    // æ›´æ–°æ ‡ç­¾
                    const roomTags = document.getElementById('roomTags');
                    if (roomTags) {
                        const tags = roomData.tags || 'æ— ';
                        roomTags.textContent = tags;
                        roomTags.title = tags;  // æ·»åŠ titleä»¥ä¾¿é¼ æ ‡æ‚¬åœæŸ¥çœ‹å®Œæ•´å†…å®¹
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] æ ‡ç­¾:', tags);
                    }
                    
                    console.log('[ç›´æ’­é—´ä¿¡æ¯] âœ… æ‰€æœ‰ä¿¡æ¯åŠ è½½å®Œæˆ');
                } else {
                    console.error('[ç›´æ’­é—´ä¿¡æ¯] âŒ APIè¿”å›å¤±è´¥:', data.message);
                    showToast('è·å–ç›´æ’­é—´ä¿¡æ¯å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('[ç›´æ’­é—´ä¿¡æ¯] âŒ åŠ è½½é”™è¯¯:', error);
                showToast('è·å–ç›´æ’­é—´ä¿¡æ¯å‡ºé”™', 'error');
            }
        }
        
        // åˆ·æ–°ç›´æ’­é—´ä¿¡æ¯
        async function refreshRoomInfo() {
            if (currentRoomId) {
                await loadRoomInfo(currentRoomId);
                showToast('ç›´æ’­é—´ä¿¡æ¯å·²åˆ·æ–°', 'success');
            }
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-CN', { hour12: false });
        }

        function formatUptime() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // ==================== é¡µé¢åˆ‡æ¢ ====================
        document.querySelectorAll('.navbar-menu-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.navbar-menu-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                const pageId = `page-${item.dataset.page}`;
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
            });
        });

        // ==================== ç›´æ’­é—´è¿æ¥ ====================
        document.getElementById('connectBtn').addEventListener('click', async () => {
            const roomInput = document.getElementById('roomInput');
            const roomValue = roomInput ? roomInput.value.trim() : '';
            if (!roomValue) {
                showToast('è¯·è¾“å…¥ç›´æ’­é—´å·æˆ–URL', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/room/parse?url=${encodeURIComponent(roomValue)}`);
                const data = await response.json();

                if (data.success) {
                    connectToRoom(data.room_id);
                } else {
                    showToast(data.message || 'è§£æç›´æ’­é—´å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
            }
        });

        document.getElementById('disconnectBtn').addEventListener('click', () => {
            if (ws) {
                ws.send(JSON.stringify({ action: 'disconnect' }));
            }
        });

        function connectToRoom(roomId) {
            console.log(`[WebSocket] å¼€å§‹è¿æ¥æˆ¿é—´: ${roomId}`);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log('[WebSocket] å·²è¿æ¥ï¼Œæ— éœ€é‡å¤è¿æ¥');
                return;
            }
            
            if (ws) {
                console.log('[WebSocket] å…³é—­ç°æœ‰è¿æ¥');
                ws.close();
            }

            showToast('æ­£åœ¨è¿æ¥ç›´æ’­é—´...', 'info');
            currentRoomId = roomId;
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/danmaku`);
            
            console.log(`[WebSocket] åˆ›å»ºè¿æ¥: ${protocol}//${window.location.host}/ws/danmaku`);

            ws.onopen = () => {
                console.log('[WebSocket] è¿æ¥å·²å»ºç«‹ï¼Œå‘é€è¿æ¥è¯·æ±‚');
                ws.send(JSON.stringify({
                    action: 'connect',
                    room_id: roomId
                }));
            };

            ws.onmessage = (event) => {
                console.log('[WebSocket] æ”¶åˆ°åŸå§‹æ•°æ®:', event.data);
                const data = JSON.parse(event.data);
                console.log('[WebSocket] è§£æåæ•°æ®:', data);
                handleWebSocketMessage(data);
            };

            ws.onclose = (event) => {
                isConnected = false;
                updateConnectionStatus(false);
                
                console.log('[WebSocket] è¿æ¥å…³é—­:', event.code, event.reason);
                
                // åªæœ‰åœ¨é¡µé¢å¯è§ä¸”ä¸æ˜¯ä¸»åŠ¨å…³é—­æ—¶æ‰é‡è¿
                if (isPageVisible && event.code !== 1000) {
                    attemptReconnect();
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                showToast('è¿æ¥é”™è¯¯', 'error');
            };
        }

        function attemptReconnect() {
            if (reconnectAttempts >= maxReconnectAttempts) {
                console.log('[WebSocket] è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿');
                showToast('è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
                clearConnectionState();
                return;
            }
            
            reconnectAttempts++;
            console.log(`[WebSocket] å°è¯•é‡è¿ (${reconnectAttempts}/${maxReconnectAttempts})`);
            
            reconnectTimer = setTimeout(() => {
                if (currentRoomId && isPageVisible) {
                    connectToRoom(currentRoomId);
                }
            }, reconnectInterval);
        }
        
        function handleWebSocketMessage(data) {
            console.log('[WebSocket] æ”¶åˆ°æ¶ˆæ¯:', data);  // è°ƒè¯•æ—¥å¿—
            console.log('[WebSocket] æ¶ˆæ¯ç±»å‹:', data.type);  // è°ƒè¯•æ—¥å¿—
            
            switch (data.type) {
                case 'connected':
                    console.log('[WebSocket] å¤„ç†è¿æ¥æˆåŠŸ');
                    isConnected = true;
                    reconnectAttempts = 0; // é‡ç½®é‡è¿è®¡æ•°
                    updateConnectionStatus(true);
                    const currentRoom = document.getElementById('currentRoom');
                    if (currentRoom) {
                        currentRoom.textContent = data.room_id || roomId || 'æœªçŸ¥';
                    }
                    saveConnectionState(); // ä¿å­˜è¿æ¥çŠ¶æ€
                    showToast('è¿æ¥æˆåŠŸ', 'success');
                    break;

                case 'disconnected':
                    console.log('[WebSocket] å¤„ç†æ–­å¼€è¿æ¥');
                    isConnected = false;
                    updateConnectionStatus(false);
                    showToast('å·²æ–­å¼€è¿æ¥', 'info');
                    break;

                case 'error':
                    console.log('[WebSocket] å¤„ç†é”™è¯¯');
                    showToast(data.message || 'è¿æ¥é”™è¯¯', 'error');
                    break;

                case 'danmaku':
                case 'gift':
                case 'superchat':
                case 'guard':
                case 'interact':
                case 'follow':
                    console.log('[WebSocket] å¤„ç†å¼¹å¹•äº‹ä»¶:', data.type);
                    // å¦‚æœæ”¶åˆ°å¼¹å¹•æ¶ˆæ¯ä½†çŠ¶æ€æ˜¾ç¤ºæœªè¿æ¥ï¼Œè‡ªåŠ¨æ›´æ–°ä¸ºå·²è¿æ¥
                    if (!isConnected) {
                        console.log('[WebSocket] æ£€æµ‹åˆ°å¼¹å¹•ä½†çŠ¶æ€ä¸ºæœªè¿æ¥ï¼Œè‡ªåŠ¨æ›´æ–°ä¸ºå·²è¿æ¥');
                        isConnected = true;
                        updateConnectionStatus(true);
                    }
                    addDanmaku(data);
                    break;

                case 'online':
                    console.log('[WebSocket] å¤„ç†åœ¨çº¿äººæ•°æ›´æ–°');
                    const online = data.data ? data.data.online : 0;
                    console.log('[WebSocket] åœ¨çº¿äººæ•°æ›´æ–°:', online, 'æ¥æº:', data.data ? data.data.source : 'æœªçŸ¥');
                    
                    // æ›´æ–°ç»Ÿè®¡å¡ç‰‡ä¸­çš„åœ¨çº¿äººæ•°
                    const statOnline = document.getElementById('statOnline');
                    if (statOnline) {
                        statOnline.textContent = online;
                    }
                    
                    // æ›´æ–°ç›´æ’­é—´ä¿¡æ¯å¡ç‰‡ä¸­çš„åœ¨çº¿äººæ°”
                    const onlineCount = document.getElementById('onlineCount');
                    if (onlineCount) {
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] åœ¨çº¿äººæ•°åŸå§‹å€¼:', online);
                        if (online > 10000) {
                            onlineCount.textContent = `${(online / 10000).toFixed(1)}ä¸‡`;
                        } else {
                            onlineCount.textContent = online.toLocaleString();
                        }
                        console.log('[ç›´æ’­é—´ä¿¡æ¯] åœ¨çº¿äººæ•°æ˜¾ç¤º:', onlineCount.textContent);
                    }
                    break;

                case 'hotspot_stats':
                    console.log('[WebSocket] å¤„ç†çˆ†ç‚¹ç»Ÿè®¡');
                    updateHotspotStats(data.data);
                    break;
            }
        }

        function updateConnectionStatus(connected) {
            console.log('[çŠ¶æ€æ›´æ–°] æ›´æ–°è¿æ¥çŠ¶æ€:', connected);
            const dot = document.getElementById('connectionDot');
            const status = document.getElementById('connectionStatus');
            const roomStatus = document.getElementById('roomStatus');
            const roomInfo = document.getElementById('roomInfo');
            const danmakuContainer = document.getElementById('danmakuContainer');

            console.log('[çŠ¶æ€æ›´æ–°] è·å–åˆ°çš„å…ƒç´ :', { dot, status, roomStatus, roomInfo, danmakuContainer });
            
            if (connected) {
                console.log('[çŠ¶æ€æ›´æ–°] è®¾ç½®ä¸ºå·²è¿æ¥çŠ¶æ€');
                if (dot) dot.classList.add('connected');
                if (status) status.textContent = 'å·²è¿æ¥';
                if (roomStatus) roomStatus.textContent = 'å·²è¿æ¥ç›´æ’­é—´';
                
                // æ›´æ–°ç›´æ’­é—´ä¿¡æ¯åŒºåŸŸ
                if (roomInfo) {
                    const statusBadge = roomInfo.querySelector('.status-badge');
                    
                    if (statusBadge) {
                        statusBadge.classList.remove('warning');
                        statusBadge.classList.add('success');
                        statusBadge.innerHTML = '<span class="status-dot"></span>å·²è¿æ¥ç›´æ’­é—´';
                    }
                }
                
                // åŠ è½½ç›´æ’­é—´è¯¦ç»†ä¿¡æ¯
                if (currentRoomId) {
                    loadRoomInfo(currentRoomId);
                }
                
                // æ¸…é™¤å¼¹å¹•å®¹å™¨çš„å ä½å†…å®¹
                if (danmakuContainer && danmakuContainer.children.length === 1) {
                    const placeholder = danmakuContainer.querySelector('div[style*="text-align: center"]');
                    if (placeholder) {
                        danmakuContainer.innerHTML = '';
                    }
                }
                
                const connectBtn = document.getElementById('connectBtn');
                const disconnectBtn = document.getElementById('disconnectBtn');
                if (connectBtn) connectBtn.style.display = 'none';
                if (disconnectBtn) disconnectBtn.style.display = 'inline-flex';
            } else {
                console.log('[çŠ¶æ€æ›´æ–°] è®¾ç½®ä¸ºæœªè¿æ¥çŠ¶æ€');
                if (dot) dot.classList.remove('connected');
                if (status) status.textContent = 'æœªè¿æ¥';
                if (roomStatus) roomStatus.textContent = 'æœªè¿æ¥ç›´æ’­é—´';
                
                // æ›´æ–°ç›´æ’­é—´ä¿¡æ¯åŒºåŸŸ
                if (roomInfo) {
                    const statusBadge = roomInfo.querySelector('.status-badge');
                    const detailsDiv = document.getElementById('roomInfoDetails');
                    const refreshBtn = document.getElementById('refreshRoomInfoBtn');
                    
                    if (statusBadge) {
                        statusBadge.classList.remove('success');
                        statusBadge.classList.add('warning');
                        statusBadge.innerHTML = '<span class="status-dot"></span>æœªè¿æ¥ç›´æ’­é—´';
                    }
                    
                    // éšè—è¯¦ç»†ä¿¡æ¯
                    if (detailsDiv) detailsDiv.style.display = 'none';
                    if (refreshBtn) refreshBtn.style.display = 'none';
                }
                
                // æ¢å¤å¼¹å¹•å®¹å™¨çš„å ä½å†…å®¹
                if (danmakuContainer && danmakuContainer.children.length === 0) {
                    danmakuContainer.innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 3rem;">
                            <p style="font-size: 1.1rem; margin-bottom: var(--spacing-md);">ğŸ“¡ ç­‰å¾…è¿æ¥ç›´æ’­é—´...</p>
                            <p>è¿æ¥åå®æ—¶æ˜¾ç¤ºå¼¹å¹•</p>
                        </div>
                    `;
                }
                
                const connectBtn = document.getElementById('connectBtn');
                const disconnectBtn = document.getElementById('disconnectBtn');
                if (connectBtn) connectBtn.style.display = 'inline-flex';
                if (disconnectBtn) disconnectBtn.style.display = 'none';
            }
        }

        // ==================== å¼¹å¹•æ˜¾ç¤º ====================
        // æ´»åŠ¨ç»Ÿè®¡
        const activityStats = {
            gifts: 0,
            scs: 0,
            guards: 0,
            follows: 0,
            giftValue: 0
        };

        function addDanmaku(data) {
            console.log('[å¼¹å¹•æ˜¾ç¤º] æ¥æ”¶åˆ°çš„æ•°æ®:', data);  // è°ƒè¯•æ—¥å¿—
            
            const container = document.getElementById('danmakuContainer');
            const danmaku = document.createElement('div');

            let typeClass = '';
            let icon = '';

            // æ›´æ–°æ´»åŠ¨ç»Ÿè®¡
            if (data.type === 'gift') {
                activityStats.gifts++;
                activityStats.giftValue += data.data.total_coin || 0;
                updateActivityStats();
            } else if (data.type === 'superchat') {
                activityStats.scs++;
                updateActivityStats();
            } else if (data.type === 'guard') {
                activityStats.guards++;
                updateActivityStats();
            } else if (data.type === 'follow') {
                activityStats.follows++;
                updateActivityStats();
            }

            switch (data.type) {
                case 'danmaku':
                    typeClass = '';
                    icon = 'ğŸ’¬';
                    break;
                case 'gift':
                    typeClass = 'gift';
                    icon = 'ğŸ';
                    break;
                case 'superchat':
                    typeClass = 'superchat';
                    icon = 'ğŸ’°';
                    break;
                case 'guard':
                    typeClass = 'guard';
                    icon = 'ğŸ‘‘';
                    break;
                case 'interact':
                    typeClass = 'interact';
                    icon = 'ğŸ‘‹';
                    break;
                case 'follow':
                    typeClass = 'follow';
                    icon = 'â¤ï¸';
                    break;
                default:
                    typeClass = '';
                    icon = 'ğŸ’¬';
            }

            const userName = data.data.user?.uname || 'æœªçŸ¥ç”¨æˆ·';
            let content = data.data.content || data.data.giftName || data.data.gift_name || (data.data.price ? `é€å‡ºä»·å€¼Â¥${data.data.price}çš„ç¤¼ç‰©` : '');
            const time = data.data.timestamp ? formatTime(data.data.timestamp * 1000) : formatTime(Date.now());

            // æ£€æŸ¥æ˜¯å¦è¢«è¿‡æ»¤
            if (data.data.filtered) {
                typeClass += ' filtered';
                if (data.data.original_content) {
                    // å¦‚æœæœ‰åŸå§‹å†…å®¹ï¼Œæ˜¾ç¤ºæ›¿æ¢åçš„å†…å®¹å’ŒåŸå› 
                    content = `${content} <span class="filter-reason">(${data.data.filter_reason || 'å·²è¿‡æ»¤'})</span>`;
                } else {
                    // åªæ˜¯æ ‡è®°
                    content = `${content} <span class="filter-mark">[å·²æ ‡è®°]</span>`;
                }
            }

            console.log('[å¼¹å¹•æ˜¾ç¤º] è§£æåçš„å†…å®¹:', { userName, content, type: data.type, filtered: data.data.filtered });  // è°ƒè¯•æ—¥å¿—

            danmaku.className = `danmaku-item ${typeClass}`;
            danmaku.innerHTML = `
                <div class="danmaku-header">
                    <span>${icon}</span>
                    <span class="danmaku-user">${userName}</span>
                    <span class="danmaku-time">${time}</span>
                </div>
                ${content ? `<div class="danmaku-content">${content}</div>` : ''}
            `;

            // å°†æ–°å¼¹å¹•æ’å…¥åˆ°æœ€ä¸Šé¢
            container.insertBefore(danmaku, container.firstChild);

            // é™åˆ¶å¼¹å¹•æ•°é‡
            while (container.children.length > 100) {
                container.removeChild(container.lastChild);
            }

            // æ›´æ–°ç»Ÿè®¡
            danmakuCount++;
            document.getElementById('statDanmaku').textContent = danmakuCount;
        }

        // ==================== AIé…ç½® ====================
        async function loadAiConfig() {
            try {
                const response = await fetch('/api/plugins/list');
                const data = await response.json();

                if (data.success) {
                    const aiPlugin = data.plugins.find(p => p.name === 'AIæ™ºèƒ½å›å¤');
                    if (aiPlugin && aiPlugin.config) {
                        const config = aiPlugin.config;
                        
                        if (config.api_key) document.getElementById('aiApiKey').value = config.api_key;
                        if (config.model) document.getElementById('aiModel').value = config.model;
                        if (config.reply_probability !== undefined) {
                            document.getElementById('aiReplyProbability').value = config.reply_probability;
                            document.getElementById('probabilityValue').textContent = config.reply_probability;
                        }
                        if (config.temperature !== undefined) {
                            document.getElementById('aiTemperature').value = config.temperature;
                            document.getElementById('temperatureValue').textContent = config.temperature;
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load AI config:', error);
            }
        }

        document.getElementById('saveAiConfig').addEventListener('click', async () => {
            const apiKeyInput = document.getElementById('aiApiKey');
            const modelInput = document.getElementById('aiModel');
            const probabilityInput = document.getElementById('aiReplyProbability');
            const temperatureInput = document.getElementById('aiTemperature');

            const apiKey = apiKeyInput ? apiKeyInput.value : '';
            const model = modelInput ? modelInput.value : '';
            const probability = probabilityInput ? parseFloat(probabilityInput.value) : 0;
            const temperature = temperatureInput ? parseFloat(temperatureInput.value) : 0;

            try {
                const response = await fetch('/api/plugins/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        plugin_name: 'AIæ™ºèƒ½å›å¤',
                        config: {
                            api_key: apiKey,
                            model: model,
                            reply_probability: parseFloat(probability),
                            temperature: parseFloat(temperature)
                        }
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                } else {
                    showToast(result.message || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        });

        // æ»‘å—å€¼æ˜¾ç¤º
        document.getElementById('aiReplyProbability').addEventListener('input', (e) => {
            if (e && e.target && e.target.value) {
                    document.getElementById('probabilityValue').textContent = e.target.value;
                }
        });

        document.getElementById('aiTemperature').addEventListener('input', (e) => {
            if (e && e.target && e.target.value) {
                    document.getElementById('temperatureValue').textContent = e.target.value;
                }
        });

        // ==================== å¿«æ·æ“ä½œ ====================
        document.getElementById('clearDanmaku').addEventListener('click', () => {
            const container = document.getElementById('danmakuContainer');
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 3rem;"><p>å¼¹å¹•å·²æ¸…ç©º</p></div>';
            danmakuCount = 0;
            document.getElementById('statDanmaku').textContent = 0;
            showToast('å¼¹å¹•å·²æ¸…ç©º', 'success');
        });

        document.getElementById('exportDanmaku').addEventListener('click', () => {
            exportDanmaku();
        });

        function exportDanmaku() {
            const container = document.getElementById('danmakuContainer');
            const items = container.querySelectorAll('.danmaku-item');
            
            if (items.length === 0) {
                showToast('æš‚æ— å¼¹å¹•æ•°æ®å¯å¯¼å‡º', 'warning');
                return;
            }

            const exportData = [];
            items.forEach(item => {
                const typeElement = item.querySelector('.danmaku-header span:first-child');
                const userElement = item.querySelector('.danmaku-user');
                const timeElement = item.querySelector('.danmaku-time');
                const contentElement = item.querySelector('.danmaku-content');

                const typeMap = {
                    'ğŸ’¬': 'danmaku',
                    'ğŸ': 'gift',
                    'ğŸ’°': 'superchat',
                    'ğŸ‘‘': 'guard',
                    'ğŸ‘‹': 'interact',
                    'â¤ï¸': 'follow'
                };

                const type = typeMap[typeElement.textContent] || 'unknown';

                exportData.push({
                    type: type,
                    user: userElement.textContent,
                    time: timeElement.textContent,
                    content: contentElement.textContent,
                    timestamp: new Date().toISOString()
                });
            });

            // åˆ›å»ºCSV
            const csvContent = 'data:text/csv;charset=utf-8,\uFEFF' + 
                'ç±»å‹,ç”¨æˆ·å,æ—¶é—´,å†…å®¹,æ—¶é—´æˆ³\n' +
                exportData.map(row => 
                    `"${row.type}","${row.user}","${row.time}","${row.content}","${row.timestamp}"`
                ).join('\n');

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `danmaku_export_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast(`å·²å¯¼å‡º ${exportData.length} æ¡å¼¹å¹•`, 'success');
        }

        function updateActivityStats() {
            document.getElementById('activityGifts').textContent = activityStats.gifts;
            document.getElementById('activityScs').textContent = activityStats.scs;
            document.getElementById('activityGuards').textContent = activityStats.guards;
            document.getElementById('activityFollows').textContent = activityStats.follows;
            
            // æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ä¸­çš„ç¤¼ç‰©æ€»ä»·å€¼å’Œæ•°é‡
            const giftValueYuan = (activityStats.giftValue / 1000).toFixed(2);
            document.getElementById('statGift').textContent = `Â¥${giftValueYuan}`;
            document.getElementById('statGiftCount').textContent = `(${activityStats.gifts})`;
        }

        function updateHotspotStats(stats) {
            if (!stats) return;
            
            // æ›´æ–°å¼¹å¹•é€Ÿåº¦
            const danmakuSpeed = stats.danmaku_speed || 0;
            document.getElementById('hotspotDanmakuSpeed').textContent = `${danmakuSpeed} æ¡/åˆ†`;
            const danmakuPercent = Math.min((danmakuSpeed / 100) * 100, 100);
            document.getElementById('hotspotDanmakuBar').style.width = `${danmakuPercent}%`;
            
            // æ›´æ–°ç¤¼ç‰©ä»·å€¼
            const giftValue = stats.gift_value_per_minute || 0;
            document.getElementById('hotspotGiftValue').textContent = `Â¥${giftValue}`;
            const giftPercent = Math.min((giftValue / 10000) * 100, 100);
            document.getElementById('hotspotGiftBar').style.width = `${giftPercent}%`;
            
            // æ›´æ–°SCæ•°é‡
            const scCount = stats.sc_count_per_minute || 0;
            document.getElementById('hotspotScCount').textContent = `${scCount} ä¸ª`;
            
            // æ›´æ–°çˆ†ç‚¹çŠ¶æ€
            const statusEl = document.getElementById('hotspotStatus');
            if (stats.is_hotspot) {
                statusEl.innerHTML = 'ğŸ”¥ çˆ†ç‚¹ä¸­ï¼';
                statusEl.style.background = 'linear-gradient(135deg, #fee2e2, #fecaca)';
                statusEl.style.color = '#dc2626';
                statusEl.style.fontWeight = '600';
            } else {
                statusEl.innerHTML = 'ç­‰å¾…æ•°æ®...';
                statusEl.style.background = 'var(--bg-secondary)';
                statusEl.style.color = 'var(--text-tertiary)';
                statusEl.style.fontWeight = '400';
            }
        }

        // ==================== ç™»å½•åŠŸèƒ½ ====================
        document.getElementById('generateQrcode').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/auth/qrcode', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    const qrcodeImage = document.getElementById('qrcodeImage');
                    qrcodeImage.innerHTML = `<img src="${data.qrcode_image}" alt="ç™»å½•äºŒç»´ç " style="width: 100%; height: 100%; border-radius: var(--radius-lg);">`;

                    // å¼€å§‹è½®è¯¢
                    pollQrcodeStatus(data.qrcode_key);
                } else {
                    showToast(data.message || 'ç”ŸæˆäºŒç»´ç å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        });

        async function pollQrcodeStatus(qrcodeKey) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch('/api/auth/qrcode/poll', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ qrcode_key: qrcodeKey })
                    });
                    const data = await response.json();

                    if (data.success) {
                        if (data.status === 'confirmed') {
                            clearInterval(interval);
                            showToast('ç™»å½•æˆåŠŸ', 'success');
                            updateLoginStatus();
                        } else if (data.status === 'expired') {
                            clearInterval(interval);
                            showToast('äºŒç»´ç å·²è¿‡æœŸ', 'warning');
                        }
                    }
                } catch (error) {
                    clearInterval(interval);
                }
            }, 2000);
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('å·²é€€å‡ºç™»å½•', 'success');
                    updateLoginStatus();
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        });

        document.getElementById('anonymousBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/auth/anonymous', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('å·²åˆ‡æ¢åˆ°åŒ¿åæ¨¡å¼', 'success');
                    updateLoginStatus();
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        });

        async function updateLoginStatus() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();

                const statusArea = document.getElementById('loginStatusArea');
                const monitorStatus = document.getElementById('monitorLoginStatus');

                if (data.logged_in) {
                    const userInfo = data.user_info;
                    statusArea.innerHTML = `
                        <div class="status-badge success">
                            <span class="status-dot"></span>
                            å·²ç™»å½•
                        </div>
                        <p style="margin-top: var(--spacing-md);"><strong>${userInfo.uname}</strong></p>
                        <p style="color: var(--text-secondary);">ç­‰çº§: Lv${userInfo.level}</p>
                    `;

                    monitorStatus.innerHTML = `
                        <div class="status-badge success">
                            <span class="status-dot"></span>
                            å·²ç™»å½•
                        </div>
                        <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-lg);">
                            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                                <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5em; font-weight: 700;">
                                    ${userInfo.uname.charAt(0)}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 1.1em; margin-bottom: 4px;">${userInfo.uname}</div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">UID: ${userInfo.mid || userInfo.uid || '-'}</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-light);">
                                <div>
                                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px;">ğŸ–ï¸ ç­‰çº§</div>
                                    <div style="font-weight: 600; color: var(--primary-color);">Lv${userInfo.level}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px;">ğŸ’° ç¡¬å¸</div>
                                    <div style="font-weight: 600; color: #f5576c;">${userInfo.coins || userInfo.money || 0}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px;">ğŸ’ Bå¸</div>
                                    <div style="font-weight: 600; color: #4facfe;">${userInfo.wallet?.bcoin_balance || 0}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px;">ğŸ‘‘ ä¼šå‘˜</div>
                                    <div style="font-weight: 600; color: #fb7299;">${userInfo.vip_type === 2 ? 'å¹´åº¦å¤§ä¼šå‘˜' : (userInfo.vip_type === 1 ? 'æœˆåº¦å¤§ä¼šå‘˜' : 'æ™®é€šç”¨æˆ·')}</div>
                                </div>
                            </div>
                        </div>
                    `;

                    document.getElementById('logoutBtn').style.display = 'inline-flex';
                } else {
                    statusArea.innerHTML = `
                        <div class="status-badge warning">
                            <span class="status-dot"></span>
                            ${data.mode === 'anonymous' ? 'åŒ¿åæ¨¡å¼' : 'æœªç™»å½•'}
                        </div>
                    `;

                    monitorStatus.innerHTML = `
                        <div class="status-badge warning">
                            <span class="status-dot"></span>
                            ${data.mode === 'anonymous' ? 'åŒ¿åæ¨¡å¼' : 'æœªç™»å½•'}
                        </div>
                        <p style="margin-top: var(--spacing-md); color: var(--text-secondary);">è¯·åœ¨è´¦æˆ·ç®¡ç†é¡µé¢ç™»å½•ä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½</p>
                    `;

                    document.getElementById('logoutBtn').style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to update login status:', error);
            }
        }

        // ==================== æ’ä»¶ç®¡ç† ====================
        async function loadPlugins() {
            try {
                const response = await fetch('/api/plugins/list');
                const data = await response.json();

                if (data.success) {
                    const pluginList = document.getElementById('pluginList');
                    pluginList.innerHTML = data.plugins.map(plugin => `
                        <div class="plugin-card ${!plugin.enabled ? 'disabled' : ''}">
                            <div class="plugin-header">
                                <div class="plugin-info">
                                    <div class="plugin-name">${plugin.name}</div>
                                    <div class="plugin-version">v${plugin.version}</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" ${plugin.enabled ? 'checked' : ''} onchange="togglePlugin('${plugin.name}', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="plugin-description">${plugin.description}</div>
                            <div class="plugin-footer">
                                <div class="plugin-author">ä½œè€…: ${plugin.author}</div>
                                <button class="btn btn-secondary btn-icon" onclick="openPluginConfig('${plugin.name}')">âš™ï¸</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load plugins:', error);
            }
        }

        async function togglePlugin(pluginName, enabled) {
            try {
                const response = await fetch('/api/plugins/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        plugin_name: pluginName,
                        enabled: enabled
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showToast(`${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}æˆåŠŸ`, 'success');
                    // é‡æ–°åŠ è½½æ’ä»¶åˆ—è¡¨ä»¥æ›´æ–°UIçŠ¶æ€
                    await loadPlugins();
                } else {
                    showToast(data.message || 'æ“ä½œå¤±è´¥', 'error');
                    // æ“ä½œå¤±è´¥æ—¶ä¹Ÿé‡æ–°åŠ è½½,æ¢å¤æ­£ç¡®çš„çŠ¶æ€
                    await loadPlugins();
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯', 'error');
                // ç½‘ç»œé”™è¯¯æ—¶ä¹Ÿé‡æ–°åŠ è½½,æ¢å¤æ­£ç¡®çš„çŠ¶æ€
                await loadPlugins();
            }
        }

        async function openPluginConfig(pluginName) {
            try {
                // è·å–æ’ä»¶åˆ—è¡¨
                const response = await fetch('/api/plugins/list');
                const data = await response.json();

                if (data.success) {
                    const plugin = data.plugins.find(p => p.name === pluginName);
                    if (!plugin) {
                        showToast('æ’ä»¶ä¸å­˜åœ¨', 'error');
                        return;
                    }

                    const modal = document.getElementById('modal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalBody = document.getElementById('modalBody');

                    modalTitle.textContent = `é…ç½® ${plugin.name}`;

                    // ç”Ÿæˆé…ç½®è¡¨å•
                    let formHtml = '';

                    if (plugin.config_schema && plugin.config_schema.length > 0) {
                        plugin.config_schema.forEach(item => {
                            const currentValue = plugin.config[item.key] !== undefined ? plugin.config[item.key] : item.default;

                            formHtml += `<div class="form-group">
                                <label class="form-label">${item.label}</label>`;

                            if (item.type === 'boolean') {
                                formHtml += `
                                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                        <input type="checkbox" id="config_${item.key}" ${currentValue ? 'checked' : ''}>
                                        <span style="color: var(--text-tertiary);">${currentValue ? 'å¯ç”¨' : 'ç¦ç”¨'}</span>
                                    </div>`;
                            } else if (item.type === 'select') {
                                formHtml += `
                                    <select class="form-control" id="config_${item.key}">
                                        ${item.options.map(opt => `
                                            <option value="${opt.value}" ${currentValue === opt.value ? 'selected' : ''}>${opt.label}</option>
                                        `).join('')}
                                    </select>`;
                            } else if (item.type === 'number') {
                                formHtml += `
                                    <input type="number" class="form-control" id="config_${item.key}" value="${currentValue}" 
                                           ${item.min !== undefined ? `min="${item.min}"` : ''} 
                                           ${item.max !== undefined ? `max="${item.max}"` : ''} 
                                           ${item.step !== undefined ? `step="${item.step}"` : ''}>`;
                            } else if (item.type === 'array') {
                                formHtml += `
                                    <textarea class="form-control" id="config_${item.key}" rows="3" placeholder="æ¯è¡Œä¸€ä¸ª">${Array.isArray(currentValue) ? currentValue.join('\n') : currentValue}</textarea>`;
                            } else if (item.type === 'textarea') {
                                const rows = item.key === 'local_qa_data' ? 8 : 4;
                                const placeholder = item.description || '';
                                const helpText = item.key === 'local_qa_data' ? 
                                    `<div style="color: var(--text-tertiary); font-size: 0.8rem; margin-top: var(--spacing-xs);">
                                        ğŸ’¡ æ ¼å¼ï¼šé—®é¢˜ | å›ç­”ï¼ˆæ¯è¡Œä¸€ä¸ªé—®ç­”å¯¹ï¼Œç”¨ç«–çº¿åˆ†éš”ï¼‰
                                        <br>
                                        ç¤ºä¾‹ï¼š
                                        <br>
                                        ä½ å¥½ | ä½ å¥½å‘€ï½ âœ¨
                                        <br>
                                        åœ¨å— | åœ¨çš„å‘¢ï½ âœ¨
                                    </div>` : '';
                                
                                formHtml += `
                                    <textarea class="form-control" id="config_${item.key}" rows="${rows}" placeholder="${placeholder}" style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 0.9rem; line-height: 1.6;">${currentValue}</textarea>
                                    ${helpText}`;
                            } else {
                                formHtml += `
                                    <input type="text" class="form-control" id="config_${item.key}" value="${currentValue}" placeholder="${item.description || ''}">`;
                            }

                            formHtml += `</div>`;
                        });

                        formHtml += `
                            <div style="margin-top: var(--spacing-xl); display: flex; gap: var(--spacing-md);">
                                <button class="btn btn-primary" id="savePluginConfig" data-plugin="${pluginName}">ä¿å­˜é…ç½®</button>
                                <button class="btn btn-secondary" onclick="document.getElementById('modal').classList.remove('active');">å–æ¶ˆ</button>
                            </div>`;
                    } else {
                        formHtml = '<p style="color: var(--text-secondary);">è¯¥æ’ä»¶æ— å¯é…ç½®é¡¹</p>';
                    }

                    modalBody.innerHTML = formHtml;
                    modal.classList.add('active');

                    // ç»‘å®šä¿å­˜æŒ‰é’®äº‹ä»¶
                    const saveBtn = document.getElementById('savePluginConfig');
                    if (saveBtn) {
                        saveBtn.addEventListener('click', async () => {
                            await savePluginConfig(pluginName);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to open plugin config:', error);
                showToast('æ‰“å¼€é…ç½®å¤±è´¥', 'error');
            }
        }

        async function savePluginConfig(pluginName) {
            try {
                const response = await fetch('/api/plugins/list');
                const data = await response.json();

                if (data.success) {
                    const plugin = data.plugins.find(p => p.name === pluginName);
                    if (!plugin) return;

                    const newConfig = {};

                    if (plugin.config_schema) {
                        plugin.config_schema.forEach(item => {
                            const input = document.getElementById(`config_${item.key}`);
                            if (!input) return;

                            let value;

                            if (item.type === 'boolean') {
                                value = input.checked;
                            } else if (item.type === 'number') {
                                value = input.value ? parseFloat(input.value) : 0;
                            } else if (item.type === 'array') {
                                value = input.value ? input.value.split('\n').filter(v => v.trim()) : [];
                            } else if (item.type === 'textarea' && item.key === 'local_qa_data') {
                                value = input.value;
                            } else {
                                value = input.value;
                            }

                            newConfig[item.key] = value;
                        });
                    }

                    const saveResponse = await fetch('/api/plugins/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            plugin_name: pluginName,
                            config: newConfig
                        })
                    });

                    const saveData = await saveResponse.json();

                    if (saveData.success) {
                        showToast('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                        document.getElementById('modal').classList.remove('active');
                        loadPlugins(); // é‡æ–°åŠ è½½æ’ä»¶åˆ—è¡¨
                    } else {
                        showToast(saveData.message || 'ä¿å­˜å¤±è´¥', 'error');
                    }
                }
            } catch (error) {
                console.error('Failed to save plugin config:', error);
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // ==================== æ¨¡æ€æ¡† ====================
        document.getElementById('modalClose').addEventListener('click', () => {
            document.getElementById('modal').classList.remove('active');
        });

        // ==================== è¿è¡Œæ—¶é—´æ›´æ–° ====================
        setInterval(() => {
            document.getElementById('uptime').textContent = `è¿è¡Œæ—¶é—´: ${formatUptime()}`;
        }, 1000);

        // ==================== ç”¨æˆ·åˆ†æåŠŸèƒ½ ====================
        async function loadGlobalAnalytics() {
            try {
                const response = await fetch('/api/analytics/global');
                const data = await response.json();

                if (data.success) {
                    const analytics = data.data;
                    document.getElementById('analyticsTotalUsers').textContent = analytics.total_users || 0;
                    document.getElementById('analyticsTotalMessages').textContent = analytics.total_messages || 0;
                    document.getElementById('analyticsTodayUsers').textContent = analytics.today_users || 0;
                    
                    // çƒ­é—¨è¯é¢˜
                    if (analytics.top_interests && analytics.top_interests.length > 0) {
                        document.getElementById('analyticsTopInterest').textContent = analytics.top_interests[0];
                    }
                }
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        async function searchUser(userName) {
            if (!userName) {
                showToast('è¯·è¾“å…¥ç”¨æˆ·å', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/analytics/user/${encodeURIComponent(userName)}`);
                const data = await response.json();

                const profileCard = document.getElementById('userProfileCard');
                const profileContent = document.getElementById('userProfileContent');

                if (data.success) {
                    const profile = data.data;
                    profileCard.style.display = 'block';
                    profileContent.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 0.85rem;">ç”¨æˆ·å</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">${profile.user_name}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 0.85rem;">æ¶ˆæ¯æ•°</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">${profile.message_count}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 0.85rem;">é¦–æ¬¡å‘è¨€</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">${profile.first_seen ? new Date(profile.first_seen * 1000).toLocaleDateString() : '-'}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 0.85rem;">æœ€è¿‘å‘è¨€</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">${profile.last_seen ? new Date(profile.last_seen * 1000).toLocaleDateString() : '-'}</div>
                            </div>
                        </div>
                        ${profile.interests && Object.keys(profile.interests).length > 0 ? `
                            <div style="margin-top: var(--spacing-lg);">
                                <div style="color: var(--text-tertiary); font-size: 0.85rem; margin-bottom: var(--spacing-sm);">å…´è¶£çˆ±å¥½</div>
                                <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm);">
                                    ${Object.entries(profile.interests).map(([interest, count]) => `
                                        <span style="background: var(--bg-secondary); padding: 4px 12px; border-radius: var(--radius-full); font-size: 0.85rem;">
                                            ${interest} (${count})
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    `;

                    // åŠ è½½ç”¨æˆ·è®°å¿†
                    loadUserMemory(userName);
                } else {
                    profileCard.style.display = 'none';
                    document.getElementById('userMemoryCard').style.display = 'none';
                    showToast(data.message || 'ç”¨æˆ·ä¸å­˜åœ¨', 'warning');
                }
            } catch (error) {
                console.error('Failed to search user:', error);
                showToast('æœç´¢å¤±è´¥', 'error');
            }
        }

        async function loadUserMemory(userName) {
            try {
                const response = await fetch(`/api/analytics/memory/${encodeURIComponent(userName)}`);
                const data = await response.json();

                const memoryCard = document.getElementById('userMemoryCard');
                const memoryContent = document.getElementById('userMemoryContent');

                if (data.success) {
                    const memory = data.data;
                    memoryCard.style.display = 'block';

                    if (memory.messages && memory.messages.length > 0) {
                        memoryContent.innerHTML = `
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${memory.messages.slice(-10).map(msg => `
                                    <div style="padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm);">
                                        <div style="font-size: 0.85rem; color: var(--text-tertiary);">${new Date(msg.timestamp * 1000).toLocaleString()}</div>
                                        <div style="margin-top: var(--spacing-xs);">${msg.content}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        memoryContent.innerHTML = '<p style="color: var(--text-secondary);">æš‚æ— è®°å¿†è®°å½•</p>';
                    }
                } else {
                    memoryCard.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load user memory:', error);
            }
        }

        async function searchByInterest(interest) {
            if (!interest) {
                showToast('è¯·è¾“å…¥å…´è¶£å…³é”®è¯', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/analytics/search?interest=${encodeURIComponent(interest)}`);
                const data = await response.json();

                const resultsDiv = document.getElementById('interestSearchResults');

                if (data.success && data.data && data.data.length > 0) {
                    resultsDiv.innerHTML = `
                        <div style="margin-top: var(--spacing-md);">
                            <div style="color: var(--text-tertiary); font-size: 0.85rem; margin-bottom: var(--spacing-sm);">æ‰¾åˆ° ${data.data.length} ä¸ªç”¨æˆ·</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: var(--spacing-sm);">
                                ${data.data.map(user => `
                                    <div style="padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-md); text-align: center; cursor: pointer;" onclick="document.getElementById('userSearchInput').value='${user}'; searchUser('${user}');">
                                        <div style="font-weight: 600;">${user}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = '<p style="color: var(--text-secondary); margin-top: var(--spacing-md);">æœªæ‰¾åˆ°ç›¸å…³ç”¨æˆ·</p>';
                }
            } catch (error) {
                console.error('Failed to search by interest:', error);
                showToast('æœç´¢å¤±è´¥', 'error');
            }
        }

        // ç”¨æˆ·åˆ†æäº‹ä»¶ç»‘å®š
        document.getElementById('searchUserBtn').addEventListener('click', () => {
            const userName = document.getElementById('userSearchInput');
            if (userName && userName.value) {
                searchUser(userName.value.trim());
            }
        });

        document.getElementById('userSearchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.value) {
                const userName = e.target.value.trim();
                searchUser(userName);
            }
        });

        document.getElementById('searchInterestBtn').addEventListener('click', () => {
            const interest = document.getElementById('interestSearchInput');
            if (interest && interest.value) {
                searchByInterest(interest.value.trim());
            }
        });

        document.getElementById('interestSearchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.value) {
                const interest = e.target.value.trim();
                searchByInterest(interest);
            }
        });

        // é¡µé¢åˆ‡æ¢æ—¶åŠ è½½å¯¹åº”æ•°æ®
        document.querySelectorAll('.navbar-menu-item').forEach(item => {
            item.addEventListener('click', () => {
                if (item.dataset.page === 'analytics') {
                    loadGlobalAnalytics();
                }
            });
        });

        // ==================== é¡µé¢ç”Ÿå‘½å‘¨æœŸç®¡ç† ====================
        
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
            isPageVisible = !document.hidden;
            
            if (isPageVisible) {
                console.log('[é¡µé¢] å˜ä¸ºå¯è§');
                // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œå¦‚æœä¹‹å‰æœ‰è¿æ¥ä½†æ–­å¼€äº†ï¼Œå°è¯•é‡è¿
                if (!isConnected && currentRoomId) {
                    const savedRoomId = restoreConnectionState();
                    if (savedRoomId) {
                        connectToRoom(savedRoomId);
                    }
                }
            } else {
                console.log('[é¡µé¢] å˜ä¸ºéšè—');
                // é¡µé¢éšè—æ—¶ä¿å­˜è¿æ¥çŠ¶æ€
                saveConnectionState();
            }
        });
        
        // ç›‘å¬é¡µé¢å¸è½½ï¼ˆåˆ·æ–°æˆ–å…³é—­ï¼‰
        window.addEventListener('beforeunload', () => {
            console.log('[é¡µé¢] å³å°†å¸è½½');
            // ä¿å­˜è¿æ¥çŠ¶æ€ï¼Œä¸ä¸»åŠ¨å…³é—­WebSocket
            saveConnectionState();
        });
        
        // ç›‘å¬é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            console.log('[é¡µé¢] åŠ è½½å®Œæˆ');
            
            // æ£€æŸ¥SessionStorageä¸­çš„æ•°æ®
            const savedRoomId = sessionStorage.getItem('ws_room_id');
            const wasConnected = sessionStorage.getItem('ws_was_connected');
            const lastActivity = sessionStorage.getItem('ws_last_activity');
            
            console.log('[é¡µé¢] SessionStorageæ•°æ®:', {
                savedRoomId,
                wasConnected,
                lastActivity,
                isConnected,
                currentRoomId
            });
            
            // å°è¯•æ¢å¤ä¹‹å‰çš„è¿æ¥
            const roomId = restoreConnectionState();
            if (roomId && !isConnected) {
                console.log('[é¡µé¢] æ¢å¤è¿æ¥åˆ°æˆ¿é—´:', roomId);
                setTimeout(() => {
                    console.log('[é¡µé¢] å¼€å§‹è‡ªåŠ¨é‡è¿...');
                    connectToRoom(roomId);
                }, 1000); // å»¶è¿Ÿ1ç§’è¿æ¥
            } else {
                console.log('[é¡µé¢] æ— éœ€æ¢å¤è¿æ¥:', { roomId, isConnected });
            }
        });

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[é¡µé¢] DOMå†…å®¹åŠ è½½å®Œæˆ');
            updateLoginStatus();
            loadPlugins();
            loadAiConfig();
            
            // å°è¯•ç«‹å³æ¢å¤è¿æ¥ï¼ˆä¸ç­‰å¾…loadäº‹ä»¶ï¼‰
            const roomId = restoreConnectionState();
            if (roomId && !isConnected) {
                console.log('[é¡µé¢] DOMåŠ è½½æ—¶ç«‹å³æ¢å¤è¿æ¥:', roomId);
                setTimeout(() => {
                    if (!isConnected) {
                        connectToRoom(roomId);
                    }
                }, 500); // è¾ƒçŸ­çš„å»¶è¿Ÿ
            }
        });
    </script>
</body>
</html>